<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P Air Channel</title>
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --glass-bg: rgba(30, 41, 59, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --input-bg: rgba(15, 23, 42, 0.6);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
            --history-item-bg: rgba(255, 255, 255, 0.05);
            --modal-bg: #1e293b; /* Solid background for modal to prevent artifacts */
            --card-bg: rgba(255, 255, 255, 0.03);
        }

        [data-theme="light"] {
            --bg-gradient: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.6);
            --text-main: #1e293b;
            --text-dim: #64748b;
            --primary: #0ea5e9;
            --primary-hover: #0284c7;
            --success: #059669;
            --danger: #ef4444;
            --warning: #d97706;
            --input-bg: rgba(241, 245, 249, 0.7);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --history-item-bg: rgba(0, 0, 0, 0.03);
            --modal-bg: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.4);
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s, border-color 0.3s; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            background: var(--bg-gradient); background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            display: flex; flex-direction: column; align-items: center; padding: 20px; color: var(--text-main);
            min-height: 100vh; margin: 0; overflow-x: hidden;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .main-layout { display: flex; flex-direction: row; gap: 24px; width: 100%; max-width: 1400px; align-items: stretch; flex: 1; margin-top: 20px; min-height: 0; }
        @media (max-width: 1024px) {
            .main-layout { flex-direction: column; align-items: center; height: auto; }
            .glass-panel { max-width: 500px !important; width: 100% !important; min-height: auto !important; }
        }

        .glass-panel {
            background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border);
            border-radius: 24px; box-shadow: var(--shadow); padding: 28px; flex: 1; min-width: 300px;
            position: relative; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; 
        }
        .panel-center { flex: 1.3; }

        .header { width: 100%; max-width: 1400px; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; flex-shrink: 0; }
        .header-left, .header-right { display: flex; align-items: center; gap: 15px; }

        .app-title { font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        #system-time { font-size: 0.9rem; font-family: monospace; color: var(--text-dim); background: rgba(0,0,0,0.1); padding: 6px 12px; border-radius: 12px; border: 1px solid var(--glass-border); }

        .icon-btn { background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-main); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .notification-dot { position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: var(--primary); border-radius: 50%; border: 2px solid var(--input-bg); display: none; }

        .footer { width: 100%; max-width: 1400px; margin-top: 40px; padding: 20px 10px; font-size: 0.75rem; color: var(--text-dim); opacity: 0.7; text-align: left; line-height: 1.5; border-top: 1px solid var(--glass-border); flex-shrink: 0; position: relative; z-index: 10; }

        .icon { width: 20px; height: 20px; } .icon-lg { width: 24px; height: 24px; } .icon-sm { width: 16px; height: 16px; }

        h2 { margin: 0; font-weight: 700; letter-spacing: 1px; word-break: break-all; font-size: 1.1rem; line-height: 1.4; font-family: monospace; color: var(--primary); }
        h3 { margin: 0; color: var(--text-dim); font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; line-height: 1.2; }

        .id-wrapper { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 5px 0; width: 100%; flex-shrink: 0; }
        .copy-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); color: var(--text-dim); width: 36px; height: 36px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .copy-btn:hover { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-1px); }
        
        #qrcode { margin: 15px auto; padding: 12px; background: white; border-radius: 16px; display: inline-block; box-shadow: 0 4px 12px rgba(0,0,0,0.1); flex-shrink: 0; }
        #qrcode img { display: block; }

        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 14px; margin: 5px 0; border-radius: 12px; border: 1px solid var(--glass-border); background: var(--input-bg); color: var(--text-main); font-size: 14px; outline: none; font-family: inherit; }

        button.action-btn { width: 100%; padding: 16px; margin-top: 5px; border-radius: 16px; background: var(--primary); color: white; border: none; cursor: pointer; font-weight: 600; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4); transition: transform 0.2s, filter 0.2s; flex-shrink: 0; }
        button.action-btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        button.action-btn:disabled { background: var(--text-dim); cursor: not-allowed; opacity: 0.7; transform: none; }
        .btn-disconnect { background: var(--danger) !important; box-shadow: 0 4px 14px rgba(239, 68, 68, 0.4) !important; }

        .file-upload-wrapper { position: relative; margin-top: 10px; border-radius: 16px; overflow: hidden; width: 100%; flex-shrink: 0; min-height: 120px; }
        .file-upload-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
        .file-upload-btn { background: var(--input-bg); border: 1px dashed var(--text-dim); color: var(--text-dim); padding: 30px 20px; border-radius: 16px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px; height: 100%; justify-content: center; transition: all 0.2s; }
        .file-upload-wrapper:hover .file-upload-btn { border-color: var(--primary); background: rgba(255,255,255,0.05); }

        .text-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--primary); cursor: pointer; font-size: 13px; padding: 12px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; border-radius: 12px; margin-top: 10px; flex-shrink: 0; }
        .text-btn:hover { background: rgba(59, 130, 246, 0.1); color: var(--text-main); }

        .progress-container { width: 100%; background: rgba(0,0,0,0.2); height: 8px; border-radius: 4px; margin: 10px 0 5px 0; overflow: hidden; display: none; flex-shrink: 0; }
        #progress-bar { width: 0%; height: 100%; background: var(--primary); border-radius: 4px; transition: width 0.1s linear; }

        .metrics-grid { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-dim); margin: 5px 0 10px 0; font-family: monospace; flex-shrink: 0; }
        .metrics-item { display: flex; align-items: center; gap: 4px; }

        #status-tag { display: inline-flex; align-items: center; gap: 8px; padding: 8px 18px; border-radius: 25px; font-size: 13px; font-weight: 700; margin: 5px auto 0 auto; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: rgba(59, 130, 246, 0.15); color: var(--primary); border: 1px solid rgba(59, 130, 246, 0.2); flex-shrink: 0; }
        #status-tag.status-online { background: rgba(16, 185, 129, 0.2); color: var(--success); border-color: rgba(16, 185, 129, 0.3); box-shadow: 0 0 15px rgba(16, 185, 129, 0.1); }
        #status-tag.status-error { background: rgba(239, 68, 68, 0.15); color: var(--danger); border-color: rgba(239, 68, 68, 0.3); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; box-shadow: 0 0 8px currentColor; }

        .history-list { margin-top: 10px; overflow-y: auto; text-align: left; flex-grow: 1; min-height: 200px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; background: var(--history-item-bg); border-radius: 12px; font-size: 13px; animation: fadeIn 0.3s ease-out; }
        .history-item-left { display: flex; align-items: center; gap: 10px; overflow: hidden; flex: 1; }
        .history-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        .history-actions { display: flex; align-items: center; gap: 10px; }
        .action-icon { color: var(--text-dim); cursor: pointer; transition: all 0.2s; display: flex; }
        .action-icon:hover { color: var(--primary); transform: scale(1.1); }

        .preview-area { margin-top: 15px; background: rgba(0,0,0,0.2); border-radius: 16px; padding: 15px; border: 1px solid var(--glass-border); display: none; flex-shrink: 0; animation: fadeIn 0.3s; }
        .preview-list { max-height: 160px; overflow-y: auto; margin-bottom: 15px; padding-right: 5px; }
        .preview-item { display: flex; flex-direction: row; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 8px; font-size: 12px; border-left: 3px solid var(--primary); gap: 10px; }
        .preview-content { flex: 1; overflow: hidden; line-height: 1.4; }
        .preview-remove-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 4px; }
        .preview-remove-btn:hover { color: var(--danger); }
        .preview-actions { display: flex; gap: 10px; flex-wrap: wrap; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(15px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: var(--modal-bg); border: 1px solid var(--glass-border); padding: 24px; border-radius: 24px; width: 90%; max-width: 420px; box-shadow: 0 30px 60px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
        
        /* --- RE-ENGINEERED BATCHER LAYOUT --- */
        .modal-large { width: 95%; max-width: 900px; height: 85vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; }
        
        .batcher-header { padding: 15px 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        
        /* Flex 1 and min-height 0 are crucial for nested scrolling */
        .batcher-layout { display: flex; flex: 1; min-height: 0; width: 100%; overflow: hidden; }
        
        .batcher-sidebar { 
            width: 300px; background: rgba(0,0,0,0.2); border-right: 1px solid var(--glass-border); 
            padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; flex-shrink: 0; 
        }
        
        .batcher-main { flex: 1; padding: 20px; overflow-y: auto; background: var(--input-bg); position: relative; }
        
        .batcher-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .batcher-card { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 8px; position: relative; transition: border 0.2s; }
        .batcher-card:hover { border-color: var(--primary); }
        .batcher-img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; background: #000; }
        .batcher-remove { position: absolute; top: -6px; right: -6px; background: var(--danger); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-size: 14px; }

        @media (max-width: 768px) {
            .batcher-layout { flex-direction: column; }
            /* Fixed height for sidebar on mobile to prevent crush */
            .batcher-sidebar { width: 100%; height: auto; max-height: 40%; border-right: none; border-bottom: 1px solid var(--glass-border); padding: 15px; flex-shrink: 0; }
            .batcher-main { height: auto; flex: 1; padding: 15px; }
        }

        .switch-label { display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--text-dim); cursor: pointer; margin: 5px 0; flex-shrink: 0; }
        
        /* Range slider container */
        .range-container { display: flex; align-items: center; gap: 10px; }
        .range-slider { flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; -webkit-appearance: none; outline: none; margin: 0; }
        .range-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--primary); cursor: pointer; border: 2px solid #fff; }
        
        /* Small number input for sliders */
        .num-input { width: 60px !important; padding: 8px !important; text-align: center; margin: 0 !important; }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 14px 28px; border-radius: 50px; box-shadow: 0 15px 35px rgba(0,0,0,0.4); display: none; align-items: center; gap: 12px; z-index: 3000; font-weight: 600; cursor: pointer; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translate(-50%, 150%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .label-row { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-dim); margin-bottom: 5px; font-weight: 600; text-transform: uppercase; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-left"><div class="app-title"><i data-lucide="zap" class="icon-lg" style="color: var(--primary);"></i> P2P Air Channel</div></div>
        <div class="header-right">
            <span id="system-time">--:--</span>
            <button class="icon-btn" id="batcher-toggle" title="Image Batcher"><i data-lucide="images" class="icon"></i><div class="notification-dot" id="batcher-dot"></div></button>
            <button class="icon-btn" id="settings-btn" title="Settings" onclick="openSettingsModal()"><i data-lucide="settings" class="icon"></i></button>
            <button class="icon-btn" id="theme-btn" title="Toggle Mode"><i data-lucide="sun" class="icon" id="icon-sun" style="display:none"></i><i data-lucide="moon" class="icon" id="icon-moon"></i></button>
        </div>
    </div>

    <div class="main-layout">
        <div class="glass-panel" style="text-align: center;">
            <div style="margin-bottom: 5px;"><h3>My Identity</h3></div>
            <div class="id-wrapper"><h2 id="my-id">...</h2><button id="copy-id-btn" class="copy-btn" title="Copy ID"><i data-lucide="copy" class="icon"></i></button></div>
            <div id="qrcode"></div>
            <div id="status-tag"><div class="status-dot"></div><span id="status-text">Initializing...</span></div>
            <p style="font-size:11px; opacity:0.6; margin-top:10px;">Share UUID to establish link.</p>
        </div>

        <div class="glass-panel panel-center">
            <div style="display:flex; align-items:center; gap:8px;"><i data-lucide="link" class="icon-sm"></i><h3>Connection</h3></div>
            <input type="text" id="peer-id-input" placeholder="Enter remote UUID">
            <button id="connect-btn" class="action-btn">Connect Device</button>
            
            <div style="margin-top:20px; display:flex; align-items:center; gap:8px;"><i data-lucide="file-up" class="icon-sm"></i><h3>File Transfer</h3></div>
            <label class="switch-label"><input type="checkbox" id="zip-mode" style="accent-color:var(--primary); transform:scale(1.1);"> Auto-pack into ZIP</label>

            <div class="file-upload-wrapper" id="upload-wrapper">
                <div class="file-upload-btn" id="drop-zone"><i data-lucide="upload-cloud" class="icon-lg" style="color:var(--primary);"></i><span style="font-weight:500;">Tap or Drop files here</span></div>
                <input type="file" id="file-input" multiple disabled>
            </div>
            <button class="text-btn" onclick="openUrlModal()"><i data-lucide="cloud-download" class="icon-sm"></i><span>Import from Drive / URL</span></button>

            <div id="preview-area" class="preview-area">
                <div style="display:flex; justify-content:space-between; margin-bottom:12px;"><b>Queue</b><span id="queue-count" style="font-size:11px;">0 files</span></div>
                <div id="preview-list" class="preview-list"></div>
                <div style="display:flex; gap:10px;">
                    <button class="action-btn" style="background:transparent; border:1px solid var(--glass-border); flex:1;" onclick="cancelTransfer()">Clear</button>
                    <button class="action-btn" style="background:var(--success); flex:2;" onclick="confirmSend()">Send Now</button>
                </div>
            </div>
            
            <div class="progress-container" id="progress-container"><div id="progress-bar"></div></div>
            <div class="metrics-grid" id="metrics-display" style="display:none">
                <div style="display:flex; align-items:center; gap:4px;"><i data-lucide="gauge" class="icon-sm"></i><span id="speed-text">0 KB/s</span></div>
                <div style="display:flex; align-items:center; gap:4px;"><i data-lucide="timer" class="icon-sm"></i><span id="eta-text">--s left</span></div>
            </div>
            <div id="transfer-info" style="font-size: 12px; color: var(--text-dim); text-align: center;">Waiting...</div>
        </div>

        <div class="glass-panel">
            <div style="display:flex; align-items:center; justify-content:space-between;"><div style="display:flex; align-items:center; gap:8px;"><i data-lucide="history" class="icon-sm"></i><h3>Activity</h3></div><span style="font-size:11px; cursor:pointer; opacity:0.6;" onclick="clearHistory()">Clear</span></div>
            <div id="history-list" class="history-list"><div style="text-align: center; color: var(--text-dim); padding: 40px 20px; font-size: 12px; font-style: italic;">No history</div></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Network Settings</h3>
            <label style="font-size:11px;">Server Preset</label>
            <select id="conf-preset" onchange="applyPreset()">
                <option value="render">Default (Render Proxy)</option>
                <option value="public">Public (0.peerjs.com)</option>
                <option value="custom">Custom Server</option>
            </select>
            <div id="custom-server-settings" style="display:none; margin-top:15px; padding-top:15px; border-top:1px solid var(--glass-border);">
                <label style="font-size:11px; color:var(--text-dim);">Host</label><input type="text" id="conf-host" placeholder="0.peerjs.com">
                <div style="display:flex; gap:10px;"><div style="flex:1;"><label style="font-size:11px; color:var(--text-dim);">Port</label><input type="number" id="conf-port" placeholder="443"></div><div style="flex:2;"><label style="font-size:11px; color:var(--text-dim);">Path</label><input type="text" id="conf-path" placeholder="/"></div></div>
                <label class="switch-label" style="font-size:13px; margin-top:5px;"><input type="checkbox" id="conf-secure"> Secure (HTTPS)</label>
            </div>
            <div style="background:rgba(59,130,246,0.1); padding:12px; border-radius:12px; border:1px solid rgba(59,130,246,0.2); margin-top:10px;">
                <label style="font-size:11px; font-weight:700;">Metered.ca API Key</label>
                <input type="text" id="metered-key" placeholder="Paste Metered Key here">
                <p style="font-size:10px; color:var(--text-dim);">Enable 100% traversal via Port 443 Relay.</p>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="action-btn" style="background:transparent; border:1px solid var(--glass-border); flex:1;" onclick="closeSettingsModal()">Cancel</button>
                <button class="action-btn" style="flex:2;" onclick="savePeerConfig()">Save & Reload</button>
            </div>
        </div>
    </div>

    <div id="url-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Cloud Import</h3>
            <input type="text" id="url-input" placeholder="GDrive Link or Direct URL">
            <label class="switch-label"><input type="checkbox" id="cors-proxy-check" checked> <span>Use CORS Proxy</span></label>
            <p class="warning-text">⚠️ Warning: Using a proxy sends traffic through a third-party server.</p>
            <div class="preview-actions" style="margin-top:20px;"><button class="action-btn" style="background:transparent; border:1px solid var(--glass-border); flex:1;" onclick="closeUrlModal()">Cancel</button><button class="action-btn" style="flex:2;" onclick="processUrlImport()">Fetch</button></div>
        </div>
    </div>

    <div id="connection-modal" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <i data-lucide="shield-check" class="icon-lg" style="color:var(--primary); margin-bottom:15px; width:48px; height:48px;"></i>
            <h3>Security Request</h3>
            <p id="conn-req-text" style="font-size:13px; color:var(--text-dim); margin-bottom:25px; line-height:1.5;"></p>
            <div class="preview-actions"><button class="action-btn" style="background:transparent; border:1px solid var(--glass-border); flex:1;" id="btn-reject-conn">Reject</button><button class="action-btn" style="margin-top:0; background:var(--success); flex:2;" id="btn-accept-conn">Accept Link</button></div>
        </div>
    </div>

    <!-- Batcher Modal -->
    <div id="batcher-modal" class="modal-overlay">
        <div class="modal-content modal-large">
            <div class="batcher-header">
                <div style="display:flex; align-items:center; gap:10px;"><i data-lucide="layers" style="color:var(--primary);"></i><h3 style="margin:0;">Image Batcher Pro</h3></div>
                <i data-lucide="x" style="cursor:pointer;" onclick="toggleBatcher(false)"></i>
            </div>
            
            <div class="batcher-layout">
                <!-- Sidebar -->
                <div class="batcher-sidebar">
                    <div>
                        <div class="label-row">RESIZE MODE</div>
                        <select id="batcher-resize-mode" onchange="updateBatcherSettingsUI()"><option value="scale">Scale Percentage</option><option value="width">Fixed Width</option></select>
                    </div>
                    
                    <div id="setting-scale-ui">
                        <div class="label-row"><span>SCALE (%)</span></div>
                        <div class="range-container">
                            <input type="range" class="range-slider" id="batcher-scale" min="10" max="100" value="80" step="5" oninput="syncInputs('batcher-scale', 'batcher-scale-num')">
                            <input type="number" id="batcher-scale-num" class="num-input" value="80" min="10" max="100" oninput="syncInputs('batcher-scale-num', 'batcher-scale')">
                        </div>
                    </div>

                    <div id="setting-width-ui" style="display:none;">
                        <div class="label-row"><span>MAX WIDTH (PX)</span></div>
                        <input type="number" id="batcher-width" placeholder="1920" value="1920">
                    </div>

                    <div>
                        <div class="label-row"><span>QUALITY (%)</span></div>
                        <div class="range-container">
                            <input type="range" class="range-slider" id="batcher-quality" min="10" max="100" value="80" step="5" oninput="syncInputs('batcher-quality', 'batcher-quality-num')">
                            <input type="number" id="batcher-quality-num" class="num-input" value="80" min="10" max="100" oninput="syncInputs('batcher-quality-num', 'batcher-quality')">
                        </div>
                    </div>

                    <div>
                        <div class="label-row">OUTPUT FORMAT</div>
                        <select id="batcher-format">
                            <option value="image/jpeg">JPG (Best for Photos)</option>
                            <option value="image/png">PNG (Lossless)</option>
                            <option value="image/webp">WebP (Efficient)</option>
                        </select>
                    </div>

                    <button class="action-btn" style="margin-top:auto;" onclick="runBatcher()" id="batcher-run-btn"><i data-lucide="zap"></i> Process & Zip</button>
                    <div id="batcher-log" style="font-size:11px; text-align:center;"></div>
                </div>

                <!-- Main Dropzone -->
                <div class="batcher-main" id="batcher-dropzone" onclick="document.getElementById('batcher-input').click()">
                    <input type="file" id="batcher-input" multiple accept="image/*" style="display:none" onchange="handleBatcherFiles(this.files)">
                    <div id="batcher-empty" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; opacity:0.4;"><i data-lucide="image-plus" style="width:48px;height:48px;"></i><p>Add Images</p></div>
                    <div class="batcher-grid" id="batcher-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="smart-toast" class="toast" onclick="toggleBatcher(true); this.style.display='none';"><i data-lucide="sparkles"></i><span>Images Detected! Open Batcher?</span></div>

    <div class="footer">Disclaimer: This tool facilitates direct P2P transfer; files are not stored on any server.<br>&copy; 2026 Haley Kwok. All rights reserved.</div>

<script>
    lucide.createIcons();
    const CHUNK_SIZE = 65536; 
    
    function generateUUID() {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => (Math.random()*16|0).toString(16));
    }

    const PRESETS = {
        render: { host: 'my-p2p-server.onrender.com', port: 443, path: '/myapp', secure: true },
        public: { host: '0.peerjs.com', port: 443, path: '/', secure: true }
    };

    async function fetchTurn(apiKey) {
        try { const res = await fetch(`https://metered.ca/api/v1/turn/credentials?apiKey=${apiKey}`); return await res.json(); } catch(e) { return null; }
    }

    async function init() {
        const config = JSON.parse(localStorage.getItem('peerConfig')) || PRESETS.render;
        const meteredKey = localStorage.getItem('meteredKey');
        let ice = [ { urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun.nextcloud.com:443' } ];
        
        if (meteredKey) { const mi = await fetchTurn(meteredKey); if (mi) ice = [...ice, ...mi]; }

        const peer = new Peer(generateUUID(), {
            host: config.host, port: config.port, path: config.path, secure: config.secure,
            config: { iceServers: ice, iceTransportPolicy: 'all' }
        });

        window.peer = peer;
        peer.on('open', id => {
            document.getElementById('my-id').innerText = id;
            const tag = document.getElementById('status-tag');
            tag.classList.remove('status-error'); tag.classList.add('status-online');
            document.getElementById('status-text').innerText = "System Online";
            new QRCode(document.getElementById("qrcode"), { text: window.location.href.split('?')[0] + "?join=" + id, width: 140, height: 140 });
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('join')) document.getElementById('peer-id-input').value = urlParams.get('join');
        });

        peer.on('connection', conn => {
            const modal = document.getElementById('connection-modal');
            document.getElementById('conn-req-text').innerText = `Remote device (${conn.peer.substring(0,8)}...) wants to connect. Do you accept?`;
            modal.style.display = 'flex';
            
            // Clean listeners
            const btnAccept = document.getElementById('btn-accept-conn');
            const btnReject = document.getElementById('btn-reject-conn');
            const newAccept = btnAccept.cloneNode(true);
            const newReject = btnReject.cloneNode(true);
            btnAccept.parentNode.replaceChild(newAccept, btnAccept);
            btnReject.parentNode.replaceChild(newReject, btnReject);

            newAccept.onclick = () => { modal.style.display = 'none'; setupConn(conn); };
            newReject.onclick = () => { modal.style.display = 'none'; conn.close(); };
        });
        
        peer.on('error', () => { 
            const tag = document.getElementById('status-tag');
            tag.classList.remove('status-online'); tag.classList.add('status-error');
            document.getElementById('status-text').innerText = "Network Error";
        });
    }

    document.getElementById('connect-btn').onclick = () => {
        if (window.activeConn) { 
            window.activeConn.close(); 
            setTimeout(() => location.reload(), 500); 
        } else {
            const tid = document.getElementById('peer-id-input').value.trim();
            if (tid) { 
                const btn = document.getElementById('connect-btn');
                btn.innerHTML = `<i data-lucide="loader-2" class="icon-sm animate-spin"></i> Connecting...`;
                lucide.createIcons();
                setupConn(window.peer.connect(tid, { reliable: true })); 
            }
        }
    };

    function setupConn(conn) {
        window.activeConn = conn;
        conn.on('open', () => {
            updateUI(true);
            conn.send({ type: 'handshake-ack' });
            setInterval(() => { if(conn.open) conn.send({type:'ping'}); }, 5000);
        });
        
        if (conn.open) { updateUI(true); conn.send({ type: 'handshake-ack' }); }

        conn.on('data', data => {
            if(data.type === 'handshake-ack') updateUI(true);
            else if(data.type === 'ping') return;
            else handleData(data);
        });
        
        conn.on('close', () => updateUI(false));
    }

    function updateUI(c) {
        const btn = document.getElementById('connect-btn');
        const tag = document.getElementById('status-tag');
        const fileInput = document.getElementById('file-input');
        if(c) {
            btn.innerHTML = `<i data-lucide="x-circle" class="icon-sm"></i> Disconnect Device`;
            btn.classList.add('btn-disconnect');
            tag.classList.add('status-online');
            document.getElementById('status-text').innerText = "Connected";
            fileInput.disabled = false;
        } else {
            btn.innerText = "Connect Device";
            btn.classList.remove('btn-disconnect');
            tag.classList.remove('status-online');
            document.getElementById('status-text').innerText = "System Online";
            fileInput.disabled = true;
        }
        lucide.createIcons();
    }

    // --- File Handlers ---
    let receivedChunks = {};
    let transferStartTime = 0;
    let historyData = [];

    async function handleData(data) {
        if (data.type === 'file-start') {
            receivedChunks[data.name] = [];
            transferStartTime = Date.now();
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('metrics-display').style.display = 'flex';
        } else if (data.type === 'file-chunk') {
            receivedChunks[data.name].push(data.chunk);
            updateProgress((receivedChunks[data.name].length / data.total) * 100, `Receiving: ${data.name}`);
            updateMetrics(receivedChunks[data.name].length * CHUNK_SIZE, data.total * CHUNK_SIZE);
        } else if (data.type === 'file-end') {
            const blob = new Blob(receivedChunks[data.name]);
            saveFile(blob, data.name);
            historyData.push({ name: data.name, blob });
            addHistory('IN', data.name, blob.size, historyData.length - 1);
            if (data.name.match(/\.(jpg|jpeg|png|webp|gif)$/i)) {
                addFileToBatcher(new File([blob], data.name, { type: blob.type }));
                document.getElementById('smart-toast').style.display = 'flex';
            }
            delete receivedChunks[data.name];
        }
    }

    function updateMetrics(done, total) {
        const now = Date.now(), sec = (now - transferStartTime) / 1000;
        if(sec <= 0) return;
        const speed = done / sec;
        document.getElementById('speed-text').innerText = formatBytes(speed) + "/s";
        const eta = speed > 0 ? Math.ceil((total - done) / speed) : 0;
        document.getElementById('eta-text').innerText = (eta > 60 ? Math.floor(eta/60) + "m" : eta + "s") + " left";
    }

    // --- Helpers ---
    function formatBytes(b) { if(b===0) return '0 B'; const k=1024, s=['B','KB','MB','GB','TB'], i=Math.floor(Math.log(b)/Math.log(k)); return parseFloat((b/Math.pow(k,i)).toFixed(2))+' '+s[i]; }
    function saveFile(b, n) { const u=URL.createObjectURL(b), a=document.createElement('a'); a.href=u; a.download=n; a.click(); }
    function updateProgress(p, m) { document.getElementById('progress-bar').style.width = p+"%"; document.getElementById('transfer-info').innerText = m; }
    
    function addHistory(t, n, s, idx) {
        const list = document.getElementById('history-list'); if(list.innerHTML.includes('No history')) list.innerHTML = '';
        const item = document.createElement('div'); item.className = 'history-item';
        const actionHtml = idx >= 0 ? `<div class="action-icon" onclick="reDownload(${idx})"><i data-lucide="download-cloud"></i></div>` : '';
        item.innerHTML = `<div style="display:flex; flex-direction:column; overflow:hidden;"><span style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${n}</span><span style="font-size:10px; opacity:0.6;">${formatBytes(s)} • ${t}</span></div><div class="history-actions">${actionHtml}</div>`;
        list.prepend(item);
        lucide.createIcons();
    }
    
    function reDownload(idx) { const item = historyData[idx]; if (item && item.blob) saveFile(item.blob, item.name); }

    // --- Modals & Presets ---
    function openSettingsModal() { 
        document.getElementById('settings-modal').style.display = 'flex'; 
        document.getElementById('metered-key').value = localStorage.getItem('meteredKey') || ''; 
        
        const conf = JSON.parse(localStorage.getItem('peerConfig')) || PRESETS.render;
        const sel = document.getElementById('conf-preset');
        const customDiv = document.getElementById('custom-server-settings');
        
        if(conf.host === PRESETS.render.host) { sel.value = 'render'; customDiv.style.display = 'none'; }
        else if(conf.host === PRESETS.public.host) { sel.value = 'public'; customDiv.style.display = 'none'; }
        else { 
            sel.value = 'custom'; 
            customDiv.style.display = 'block';
            document.getElementById('conf-host').value = conf.host;
            document.getElementById('conf-port').value = conf.port || '';
            document.getElementById('conf-path').value = conf.path;
            document.getElementById('conf-secure').checked = conf.secure;
        }
    }
    
    function closeSettingsModal() { document.getElementById('settings-modal').style.display = 'none'; }
    
    function savePeerConfig() { 
        const k = document.getElementById('metered-key').value.trim(); 
        if(k) localStorage.setItem('meteredKey', k); 
        
        const p = document.getElementById('conf-preset').value; 
        if(p!=='custom') {
            localStorage.setItem('peerConfig', JSON.stringify(PRESETS[p])); 
        } else {
            const h = document.getElementById('conf-host').value;
            const pt = document.getElementById('conf-port').value;
            const pa = document.getElementById('conf-path').value;
            const s = document.getElementById('conf-secure').checked;
            localStorage.setItem('peerConfig', JSON.stringify({host:h, port:pt, path:pa, secure:s}));
        }
        location.reload(); 
    }
    
    function applyPreset() {
        const val = document.getElementById('conf-preset').value;
        document.getElementById('custom-server-settings').style.display = val === 'custom' ? 'block' : 'none';
    }
    
    function openUrlModal() { document.getElementById('url-modal').style.display = 'flex'; }
    function closeUrlModal() { document.getElementById('url-modal').style.display = 'none'; }
    function clearHistory() { document.getElementById('history-list').innerHTML = ''; historyData = []; }
    function cancelTransfer() { document.getElementById('preview-area').style.display = 'none'; document.getElementById('upload-wrapper').style.display = 'block'; document.querySelector('.text-btn').style.display = 'flex'; filesQueue = []; }

    // Send files logic
    document.getElementById('file-input').onchange = (e) => { if (e.target.files.length > 0) { filesQueue = Array.from(e.target.files); renderPreview(); } };
    function handleAddMoreFiles(input) { if(input.files.length > 0) { filesQueue = [...filesQueue, ...Array.from(input.files)]; renderPreview(); input.value = ""; } }
    
    function renderPreview() {
        const list = document.getElementById('preview-list');
        document.getElementById('queue-count').innerText = `${filesQueue.length} files`;
        list.innerHTML = '';
        filesQueue.forEach((f, i) => {
            const item = document.createElement('div');
            item.className = 'preview-item';
            item.innerHTML = `<div class="preview-content"><b>${f.name}</b><br><small>${formatBytes(f.size)}</small></div><i data-lucide="trash-2" class="preview-remove-btn" onclick="filesQueue.splice(${i},1);renderPreview()"></i>`;
            list.appendChild(item);
        });
        document.getElementById('upload-wrapper').style.display = 'none';
        document.querySelector('.text-btn').style.display = 'none';
        document.getElementById('preview-area').style.display = 'block';
        lucide.createIcons();
    }
    
    function confirmSend() { if(filesQueue.length) { sendFiles(filesQueue); cancelTransfer(); } }

    async function sendFiles(files) {
        if (!activeConn) return;
        document.getElementById('progress-container').style.display = 'block';
        document.getElementById('metrics-display').style.display = 'flex';
        for (let file of files) {
            activeConn.send({ type: 'file-start', name: file.name, size: file.size });
            transferStartTime = Date.now();
            const total = Math.ceil(file.size / CHUNK_SIZE);
            for (let i = 0; i < total; i++) {
                const chunk = file.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
                activeConn.send({ type: 'file-chunk', name: file.name, chunk, current: i + 1, total });
                updateMetrics((i + 1) * CHUNK_SIZE, file.size);
                updateProgress(((i + 1) / total) * 100, `Sending: ${file.name}`);
                if (i % 10 === 0) await new Promise(r => setTimeout(r, 10));
            }
            activeConn.send({ type: 'file-end', name: file.name });
            addHistory('OUT', file.name, file.size, -1);
        }
    }

    // Batcher Logic
    let batcherFiles = [];
    document.getElementById('batcher-toggle').onclick = () => toggleBatcher(true);
    function toggleBatcher(s) { document.getElementById('batcher-modal').style.display = s?'flex':'none'; if(s) renderBatcher(); }
    function addFileToBatcher(f) { batcherFiles.push({ f, id: Math.random(), preview: URL.createObjectURL(f) }); }
    function handleBatcherFiles(fl) { Array.from(fl).filter(f=>f.type.startsWith('image/')).forEach(addFileToBatcher); renderBatcher(); }
    
    function renderBatcher() {
        const g = document.getElementById('batcher-grid'); document.getElementById('batcher-empty').style.display = batcherFiles.length?'none':'flex';
        g.innerHTML = ''; batcherFiles.forEach(item => {
            const c = document.createElement('div'); c.className = 'batcher-card';
            c.onclick = (e) => e.stopPropagation();
            c.innerHTML = `<img src="${item.preview}" class="batcher-img"><div class="batcher-remove" onclick="batcherFiles=batcherFiles.filter(i=>i.id!=${item.id});renderBatcher();event.stopPropagation()">×</div>`;
            g.appendChild(c);
        });
    }

    function syncInputs(src, dest) {
        document.getElementById(dest).value = document.getElementById(src).value;
    }

    function updateBatcherSettingsUI() { 
        const mode = document.getElementById('batcher-resize-mode').value; 
        document.getElementById('setting-scale-ui').style.display = mode==='scale'?'block':'none'; 
        document.getElementById('setting-width-ui').style.display = mode==='width'?'block':'none'; 
    }
    
    async function runBatcher() {
        const btn = document.getElementById('batcher-run-btn');
        const log = document.getElementById('batcher-log');
        btn.disabled = true; btn.innerText = "Processing...";
        const zip = new JSZip();
        const s = { mode: document.getElementById('batcher-resize-mode').value, scale: document.getElementById('batcher-scale').value / 100, width: parseInt(document.getElementById('batcher-width').value), quality: document.getElementById('batcher-quality').value / 100, format: document.getElementById('batcher-format').value };
        for (let item of batcherFiles) {
            log.innerText = `Processing ${item.f.name}...`;
            const blob = await processImg(item.f, s);
            zip.file(item.f.name.split('.')[0] + "_processed." + s.format.split('/')[1], blob);
        }
        const content = await zip.generateAsync({type:"blob"});
        saveFile(content, "Batch_Export.zip");
        log.innerText = "Done!";
        btn.disabled = false; btn.innerHTML = '<i data-lucide="zap"></i> Process & Zip'; lucide.createIcons();
    }
    
    function processImg(f, s) { return new Promise(res => { const img = new Image(); img.src = URL.createObjectURL(f); img.onload = () => { const can = document.createElement('canvas'); let w = img.width, h = img.height; if(s.mode === 'scale') { w *= s.scale; h *= s.scale; } else { const r = h/w; w = s.width; h = w*r; } can.width = w; can.height = h; can.getContext('2d').drawImage(img, 0,0, w, h); can.toBlob(res, s.format, s.quality); } }); }

    setInterval(() => { document.getElementById('system-time').innerText = new Date().toLocaleTimeString([], {hour12:false}); }, 1000);
    document.getElementById('theme-btn').onclick = () => {
        const cur = document.documentElement.getAttribute('data-theme');
        const next = cur === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        document.getElementById('icon-sun').style.display = next==='light'?'block':'none';
        document.getElementById('icon-moon').style.display = next==='dark'?'block':'none';
    };

    init();
</script>
</body>
</html>
