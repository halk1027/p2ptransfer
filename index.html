<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Air Channel</title>
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --glass-bg: rgba(30, 41, 59, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --input-bg: rgba(15, 23, 42, 0.6);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
            --history-item-bg: rgba(255, 255, 255, 0.05);
            --modal-bg: rgba(15, 23, 42, 0.95);
            --card-bg: rgba(255, 255, 255, 0.03);
        }

        [data-theme="light"] {
            --bg-gradient: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.6);
            --text-main: #1e293b;
            --text-dim: #64748b;
            --primary: #0ea5e9;
            --primary-hover: #0284c7;
            --success: #059669;
            --danger: #ef4444;
            --warning: #d97706;
            --input-bg: rgba(241, 245, 249, 0.7);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --history-item-bg: rgba(0, 0, 0, 0.03);
            --modal-bg: rgba(255, 255, 255, 0.95);
            --card-bg: rgba(255, 255, 255, 0.4);
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-gradient);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: var(--text-main);
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .main-layout {
            display: flex;
            flex-direction: row;
            gap: 24px;
            width: 100%;
            max-width: 1400px;
            align-items: stretch;
            flex: 1;
            margin-top: 20px;
        }

        @media (max-width: 1024px) {
            .main-layout { flex-direction: column; align-items: center; }
            .glass-panel { max-width: 500px !important; width: 100% !important; min-height: auto !important; }
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--shadow);
            padding: 28px;
            flex: 1; 
            min-width: 300px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .panel-center { flex: 1.3; }

        .header {
            width: 100%;
            max-width: 1400px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
        }

        .header-left, .header-right { display: flex; align-items: center; gap: 15px; }

        .app-title { font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        
        #system-time {
            font-size: 0.9rem; font-family: monospace; color: var(--text-dim);
            background: rgba(0,0,0,0.1); padding: 6px 12px; border-radius: 12px; border: 1px solid var(--glass-border);
        }

        .icon-btn {
            background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-main);
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; cursor: pointer; backdrop-filter: blur(10px); position: relative;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }

        .notification-dot {
            position: absolute; top: 0; right: 0; width: 12px; height: 12px;
            background: var(--primary); border-radius: 50%; border: 2px solid var(--input-bg); display: none;
        }

        .footer {
            width: 100%; max-width: 1400px; margin-top: 40px; padding: 20px 10px;
            font-size: 0.75rem; color: var(--text-dim); opacity: 0.7; text-align: left; line-height: 1.5;
            border-top: 1px solid var(--glass-border);
        }

        .icon { width: 20px; height: 20px; }
        .icon-lg { width: 24px; height: 24px; }
        .icon-sm { width: 16px; height: 16px; }

        h2 { 
            margin: 0; font-weight: 700; letter-spacing: 1px; word-break: break-all;
            font-size: 1.1rem; line-height: 1.4; font-family: monospace; color: var(--primary);
        }
        
        h3 { 
            margin: 0; color: var(--text-dim); font-size: 0.85rem; font-weight: 600; 
            text-transform: uppercase; letter-spacing: 1px; line-height: 1.2; 
        }

        .id-wrapper { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 5px 0; width: 100%; }

        .copy-btn {
            background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); color: var(--text-dim);
            width: 36px; height: 36px; border-radius: 10px; cursor: pointer; display: flex; align-items: center;
            justify-content: center; transition: all 0.2s; flex-shrink: 0; 
        }
        .copy-btn:hover { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-1px); }
        
        #qrcode {
            margin: 15px auto; padding: 12px; background: white; border-radius: 16px;
            display: inline-block; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #qrcode img { display: block; }

        input[type="text"], input[type="number"], select {
            width: 100%; padding: 14px; margin: 5px 0; border-radius: 12px; border: 1px solid var(--glass-border);
            background: var(--input-bg); color: var(--text-main); font-size: 14px; outline: none;
        }

        button.action-btn {
            width: 100%; padding: 16px; margin-top: 5px; border-radius: 16px;
            background: var(--primary); color: white; border: none; cursor: pointer;
            font-weight: 600; font-size: 16px; display: flex; align-items: center; justify-content: center;
            gap: 8px; box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4); transition: transform 0.2s, filter 0.2s;
        }
        button.action-btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        button.action-btn:disabled { background: var(--text-dim); cursor: not-allowed; opacity: 0.7; transform: none; }

        .btn-disconnect { background: var(--danger) !important; box-shadow: 0 4px 14px rgba(239, 68, 68, 0.4) !important; }

        .file-upload-wrapper { position: relative; margin-top: 10px; border-radius: 16px; overflow: hidden; width: 100%; }
        .file-upload-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
        
        .file-upload-btn {
            background: var(--input-bg); border: 1px dashed var(--text-dim); color: var(--text-dim);
            padding: 30px 20px; border-radius: 16px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px;
            transition: all 0.2s;
        }
        .file-upload-wrapper:hover .file-upload-btn { border-color: var(--primary); background: rgba(255,255,255,0.05); }

        .text-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--primary); cursor: pointer;
            font-size: 13px; padding: 12px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%; border-radius: 12px; margin-top: 10px;
        }
        .text-btn:hover { background: rgba(59, 130, 246, 0.1); color: var(--text-main); }

        .progress-container { width: 100%; background: rgba(0,0,0,0.2); height: 8px; border-radius: 4px; margin: 15px 0 5px 0; overflow: hidden; display: none; }
        #progress-bar { width: 0%; height: 100%; background: var(--primary); border-radius: 4px; transition: width 0.1s linear; }

        .metrics-grid { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-dim); margin: 5px 0 10px 0; font-family: monospace; }
        .metrics-item { display: flex; align-items: center; gap: 4px; }

        #status-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 18px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 700;
            margin: 5px auto 0 auto;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(59, 130, 246, 0.15); 
            color: var(--primary);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        #status-tag.status-online {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.1);
        }
        #status-tag.status-error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border-color: rgba(239, 68, 68, 0.3);
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; box-shadow: 0 0 8px currentColor; }

        .history-list { margin-top: 10px; overflow-y: auto; text-align: left; flex-grow: 1; min-height: 250px; }
        .history-item {
            display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px;
            background: var(--history-item-bg); border-radius: 12px; font-size: 13px; animation: fadeIn 0.3s ease-out;
        }
        .history-item-left { display: flex; align-items: center; gap: 10px; overflow: hidden; flex: 1; }
        .history-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        .history-actions { display: flex; align-items: center; gap: 10px; }
        .action-icon { color: var(--text-dim); cursor: pointer; transition: all 0.2s; display: flex; }
        .action-icon:hover { color: var(--primary); transform: scale(1.1); }

        .preview-area { margin-top: 15px; background: rgba(0,0,0,0.2); border-radius: 16px; padding: 15px; border: 1px solid var(--glass-border); display: none; animation: fadeIn 0.3s; }
        .preview-list { max-height: 160px; overflow-y: auto; margin-bottom: 15px; padding-right: 5px; }
        .preview-item {
            display: flex; flex-direction: row; align-items: center; padding: 10px; background: rgba(255,255,255,0.05);
            border-radius: 10px; margin-bottom: 8px; font-size: 12px; border-left: 3px solid var(--primary); gap: 10px;
        }
        .preview-content { flex: 1; overflow: hidden; line-height: 1.4; }
        .preview-remove-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 4px; }
        .preview-remove-btn:hover { color: var(--danger); }
        .preview-actions { display: flex; gap: 10px; flex-wrap: wrap; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7);
            backdrop-filter: blur(15px); z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-content { background: var(--modal-bg); border: 1px solid var(--glass-border); padding: 24px; border-radius: 24px; width: 90%; max-width: 420px; box-shadow: 0 30px 60px rgba(0,0,0,0.5); }
        .modal-large { max-width: 960px; height: 85vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; }

        .warning-text {
            color: var(--warning);
            font-size: 11px;
            margin-top: 10px;
            text-align: left;
            padding-left: 5px;
            line-height: 1.5;
            background: rgba(245, 158, 11, 0.1);
            padding: 8px;
            border-radius: 8px;
            border-left: 3px solid var(--warning);
        }

        .batcher-layout { display: flex; height: 100%; overflow: hidden; }
        .batcher-sidebar { width: 280px; background: rgba(0,0,0,0.2); border-right: 1px solid var(--glass-border); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .batcher-main { flex: 1; padding: 25px; overflow-y: auto; background: var(--input-bg); }
        .batcher-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .batcher-card { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 10px; position: relative; transition: border 0.2s; }
        .batcher-card:hover { border-color: var(--primary); }
        .batcher-img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 10px; background: #000; }
        .batcher-remove { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        @media (max-width: 768px) {
            .batcher-layout { flex-direction: column; }
            .batcher-sidebar { width: 100%; height: auto; max-height: 40%; border-right: none; border-bottom: 1px solid var(--glass-border); flex-shrink: 0; }
            .batcher-main { height: auto; flex: 1; }
        }

        .switch-label { display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--text-dim); cursor: pointer; margin: 5px 0; }
        .range-slider { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; -webkit-appearance: none; outline: none; margin: 10px 0; }
        .range-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--primary); cursor: pointer; border: 2px solid #fff; }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--primary); color: white; padding: 14px 28px; border-radius: 50px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4); display: none; align-items: center; gap: 12px;
            z-index: 3000; font-weight: 600; cursor: pointer; animation: slideUp 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes slideUp { from { transform: translate(-50%, 150%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-left">
            <div class="app-title"><i data-lucide="zap" class="icon-lg" style="color: var(--primary);"></i> P2P Air Channel</div>
        </div>
        <div class="header-right">
            <span id="system-time">--:--</span>
            <button class="icon-btn" id="batcher-toggle" title="Image Batcher"><i data-lucide="images" class="icon"></i><div class="notification-dot" id="batcher-dot"></div></button>
            <button class="icon-btn" id="settings-btn" title="Network Settings" onclick="openSettingsModal()"><i data-lucide="settings" class="icon"></i></button>
            <button class="icon-btn" id="theme-btn" title="Toggle Mode"><i data-lucide="sun" class="icon" id="icon-sun" style="display:none"></i><i data-lucide="moon" class="icon" id="icon-moon"></i></button>
        </div>
    </div>

    <div class="main-layout">
        <!-- LEFT PANEL -->
        <div class="glass-panel" style="text-align: center;">
            <div style="margin-bottom: 5px;"><h3>My Identity</h3></div>
            <div class="id-wrapper">
                <h2 id="my-id">...</h2>
                <button id="copy-id-btn" class="copy-btn" title="Copy ID"><i data-lucide="copy" class="icon"></i></button>
            </div>
            <div id="qrcode"></div>
            <div id="status-tag"><div class="status-dot"></div><span id="status-text">Initializing...</span></div>
            <div style="margin-top: 15px; font-size: 12px; color: var(--text-dim); text-align: center; line-height: 1.5;">
                Scan QR or share UUID to establish link.
            </div>
        </div>

        <!-- CENTER PANEL -->
        <div class="glass-panel panel-center">
            <div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="link" class="icon-sm"></i><h3>Connection</h3></div>
            <input type="text" id="peer-id-input" placeholder="Enter remote UUID">
            <button id="connect-btn" class="action-btn">Connect Device</button>
            
            <div style="margin-top: 20px; display: flex; align-items: center; gap: 8px;"><i data-lucide="file-up" class="icon-sm"></i><h3>File Transfer</h3></div>
            <label class="switch-label"><input type="checkbox" id="zip-mode" style="accent-color: var(--primary); transform: scale(1.1);"> <span>Auto-pack received files into ZIP</span></label>

            <div class="file-upload-wrapper" id="upload-wrapper">
                <div class="file-upload-btn" id="drop-zone">
                    <i data-lucide="upload-cloud" class="icon-lg" style="width:40px; height:40px; color: var(--primary);"></i>
                    <span style="font-weight: 500;">Tap or Drop files here</span>
                </div>
                <input type="file" id="file-input" multiple disabled>
            </div>
            <button class="text-btn" onclick="openUrlModal()"><i data-lucide="cloud-download" class="icon-sm"></i><span>Import from Google Drive / URL</span></button>

            <div id="preview-area" class="preview-area">
                <div style="display:flex; justify-content:space-between; margin-bottom:12px; align-items: center;">
                    <b style="font-size: 14px;">Queue Management</b>
                    <span id="queue-count" style="font-size:11px; padding: 2px 8px; background: rgba(255,255,255,0.1); border-radius: 10px;">0 files</span>
                </div>
                <div id="preview-list" class="preview-list"></div>
                <div class="preview-actions">
                    <button class="btn-cancel" style="padding: 12px; border-radius: 12px; border: 1px solid var(--glass-border); background: none; color: var(--text-main); cursor: pointer;" onclick="cancelTransfer()">Clear All</button>
                    <input type="file" id="add-more-input" multiple style="display:none" onchange="handleAddMoreFiles(this)">
                    <button class="action-btn" style="margin-top:0; flex:1; background: var(--input-bg); border: 1px solid var(--glass-border);" onclick="document.getElementById('add-more-input').click()">+ Add Files</button>
                    <button class="action-btn" style="margin-top:0; flex:1.5; background:var(--success);" onclick="confirmSend()">Send Now</button>
                </div>
            </div>
            
            <div class="progress-container" id="progress-container"><div id="progress-bar"></div></div>
            
            <div class="metrics-grid" id="metrics-display" style="display:none">
                <div class="metrics-item"><i data-lucide="gauge" class="icon-sm"></i><span id="speed-text">0 KB/s</span></div>
                <div class="metrics-item"><i data-lucide="timer" class="icon-sm"></i><span id="eta-text">--s</span></div>
            </div>

            <div id="transfer-info" style="font-size: 12px; color: var(--text-dim); text-align: center; min-height: 18px;">Waiting for connection...</div>
        </div>

        <!-- RIGHT PANEL -->
        <div class="glass-panel">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="history" class="icon-sm"></i><h3>Activity History</h3></div>
                <span style="font-size: 11px; opacity: 0.6; cursor: pointer; text-decoration: underline;" onclick="clearHistory()">Clear</span>
            </div>
            <div id="history-list" class="history-list">
                <div style="text-align: center; color: var(--text-dim); padding: 40px 20px; font-size: 12px; font-style: italic;">No recent transfers</div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Network Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px;">Network Settings</h3>
            <p style="font-size:12px; color:var(--text-dim); margin-bottom:15px;">
                Configure PeerServer. Default is Render (custom proxy).
            </p>
            
            <label style="font-size:12px; color:var(--text-dim);">Server Preset</label>
            <select id="conf-preset" onchange="applyPreset()" style="margin-bottom: 10px;">
                <option value="render">Default (Render Proxy)</option>
                <option value="public">Public (0.peerjs.com)</option>
                <option value="custom">Custom / Localhost</option>
            </select>

            <label style="font-size:12px; color:var(--text-dim);">Host</label>
            <input type="text" id="conf-host" placeholder="my-p2p-server.onrender.com">
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label style="font-size:12px; color:var(--text-dim);">Port</label>
                    <input type="number" id="conf-port" placeholder="443">
                </div>
                <div style="flex:2;">
                    <label style="font-size:12px; color:var(--text-dim);">Path</label>
                    <input type="text" id="conf-path" placeholder="/myapp">
                </div>
            </div>
            
            <label class="switch-label" style="margin-top:10px;">
                <input type="checkbox" id="conf-secure" checked> <span>Secure (HTTPS/WSS)</span>
            </label>

            <div class="preview-actions" style="margin-top:20px;">
                <button class="btn-cancel" style="padding:12px; border-radius:12px; border:1px solid var(--glass-border); flex:1; cursor:pointer;" onclick="closeSettingsModal()">Cancel</button>
                <button class="action-btn" style="margin-top:0; flex:2;" onclick="savePeerConfig()">Save & Reload</button>
            </div>
        </div>
    </div>

    <div id="url-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px;">Cloud Import</h3>
            <input type="text" id="url-input" placeholder="Google Drive sharing link or URL">
            <label class="switch-label"><input type="checkbox" id="cors-proxy-check"> <span>Use CORS Proxy (for GDrive)</span></label>
            <p class="warning-text">
                ⚠️ Warning: Using a proxy sends traffic through a third-party server. Do not use for sensitive data.
            </p>
            <div class="preview-actions" style="margin-top:20px;">
                <button class="btn-cancel" style="padding:12px; border-radius:12px; border:1px solid var(--glass-border); flex:1; cursor:pointer;" onclick="closeUrlModal()">Cancel</button>
                <button class="action-btn" style="margin-top:0; flex:2;" onclick="processUrlImport()">Fetch File</button>
            </div>
        </div>
    </div>

    <div id="connection-modal" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <i data-lucide="shield-check" class="icon-lg" style="color:var(--primary); margin-bottom:15px; width:48px; height:48px;"></i>
            <h3 style="margin-bottom: 10px;">Security Request</h3>
            <p id="conn-req-text" style="font-size:13px; color:var(--text-dim); margin-bottom:25px; line-height:1.5;"></p>
            <div class="preview-actions">
                <button class="btn-cancel" style="padding:12px; border-radius:12px; border:1px solid var(--glass-border); flex:1; cursor:pointer;" id="btn-reject-conn">Reject</button>
                <button class="action-btn" style="margin-top:0; background:var(--success); flex:2;" id="btn-accept-conn">Accept Link</button>
            </div>
        </div>
    </div>

    <div id="batcher-modal" class="modal-overlay">
        <div class="modal-content modal-large">
            <div style="padding: 18px 24px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.1);">
                <div style="display: flex; align-items: center; gap: 10px;"><i data-lucide="layers" style="color: var(--primary);"></i><h3 style="margin: 0; font-size: 1rem;">Image Batcher Pro</h3></div>
                <i data-lucide="x" style="cursor: pointer; opacity:0.7;" onclick="toggleBatcher(false)"></i>
            </div>
            <div class="batcher-layout">
                <div class="batcher-sidebar">
                    <div>
                        <div style="font-size:11px; margin-bottom:5px; color:var(--text-dim);">RESIZE MODE</div>
                        <select id="batcher-resize-mode" onchange="updateBatcherSettingsUI()"><option value="scale">Scale Percentage</option><option value="width">Fixed Width (px)</option></select>
                    </div>
                    <div>
                        <div style="display:flex; justify-content:space-between; font-size:11px; color:var(--text-dim);"><span>SCALE / WIDTH</span><span id="scale-val" style="color:var(--primary);">80%</span></div>
                        <input type="range" class="range-slider" id="batcher-scale" min="10" max="100" value="80" step="5" oninput="document.getElementById('scale-val').innerText=this.value+'%'">
                        <input type="number" id="batcher-width" style="display:none" value="1920">
                    </div>
                    <div>
                        <div style="display:flex; justify-content:space-between; font-size:11px; color:var(--text-dim);"><span>QUALITY</span><span id="quality-val" style="color:var(--primary);">80%</span></div>
                        <input type="range" class="range-slider" id="batcher-quality" min="10" max="100" value="80" step="5" oninput="document.getElementById('quality-val').innerText=this.value+'%'">
                    </div>
                    <div>
                        <div style="font-size:11px; margin-bottom:5px; color:var(--text-dim);">OUTPUT FORMAT</div>
                        <select id="batcher-format">
                            <option value="image/jpeg">JPG (Best for Photos)</option>
                            <option value="image/png">PNG (Lossless)</option>
                            <option value="image/webp">WebP (Efficient)</option>
                        </select>
                    </div>
                    <button class="action-btn" style="margin-top:auto;" onclick="runBatcher()" id="batcher-run-btn"><i data-lucide="zap" class="icon-sm"></i> Run Processor</button>
                    <div id="batcher-log" style="font-size: 11px; color: var(--text-dim); text-align:center;"></div>
                </div>
                <div class="batcher-main" id="batcher-dropzone" onclick="document.getElementById('batcher-input').click()">
                    <input type="file" id="batcher-input" multiple accept="image/*" style="display:none" onchange="handleBatcherFiles(this.files); this.value=''">
                    <div id="batcher-empty" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; opacity: 0.4;">
                        <i data-lucide="plus-circle" style="width:56px; height:56px; margin-bottom:15px;"></i>
                        <p style="font-size:1.1rem; font-weight:600;">Click or Drop Images Here</p>
                        <p style="font-size:0.9rem; margin-top:5px;">Received images will also appear here</p>
                    </div>
                    <div class="batcher-grid" id="batcher-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="smart-toast" class="toast" onclick="toggleBatcher(true); this.style.display='none';"><i data-lucide="sparkles"></i><span>Images Received! Open Batcher?</span></div>

    <div class="footer">
        Disclaimer: This tool facilitates direct P2P transfer; files are not stored on any server. Reloading the page will result in the loss of transfer history.<br>
        &copy; 2026 Haley Kwok. All rights reserved.
    </div>

<script>
    lucide.createIcons();
    const CHUNK_SIZE = 16384 * 4; 
    
    function generateUUID() {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) {
            return crypto.randomUUID();
        }
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    const customId = generateUUID();
    document.getElementById('my-id').innerText = customId;
    
    // --- Config Logic ---
    const DEFAULT_CONFIG = {
        host: 'my-p2p-server.onrender.com',
        port: 443,
        path: '/myapp',
        secure: true
    };

    const PUBLIC_CONFIG = {
        host: '0.peerjs.com',
        port: 443,
        path: '/',
        secure: true
    };

    function getPeerConfig() {
        const saved = localStorage.getItem('peerConfig');
        return saved ? JSON.parse(saved) : DEFAULT_CONFIG;
    }

    function savePeerConfig() {
        const host = document.getElementById('conf-host').value.trim();
        const port = document.getElementById('conf-port').value.trim();
        const path = document.getElementById('conf-path').value.trim();
        const secure = document.getElementById('conf-secure').checked;

        if (!host) {
            localStorage.removeItem('peerConfig');
        } else {
            localStorage.setItem('peerConfig', JSON.stringify({ host, port: port ? parseInt(port) : undefined, path: path || '/', secure }));
        }
        location.reload();
    }

    function applyPreset() {
        const preset = document.getElementById('conf-preset').value;
        if (preset === 'render') setInputValues(DEFAULT_CONFIG);
        else if (preset === 'public') setInputValues(PUBLIC_CONFIG);
    }

    function setInputValues(conf) {
        document.getElementById('conf-host').value = conf.host;
        document.getElementById('conf-port').value = conf.port;
        document.getElementById('conf-path').value = conf.path;
        document.getElementById('conf-secure').checked = conf.secure;
    }

    function openSettingsModal() {
        document.getElementById('settings-modal').style.display = 'flex';
        const config = getPeerConfig();
        setInputValues(config);
        
        const presetSelect = document.getElementById('conf-preset');
        if (config.host === DEFAULT_CONFIG.host && config.path === DEFAULT_CONFIG.path) presetSelect.value = 'render';
        else if (config.host === PUBLIC_CONFIG.host && config.path === PUBLIC_CONFIG.path) presetSelect.value = 'public';
        else presetSelect.value = 'custom';
    }
    
    function closeSettingsModal() { document.getElementById('settings-modal').style.display = 'none'; }

    // Initialize Peer with Config + STUN Injection
    const userConfig = getPeerConfig();
    let peerOptions = userConfig || {};
    
    // Default STUN servers for robust NAT traversal
    const ICE_SERVERS = [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' },
        { urls: 'stun:stun4.l.google.com:19302' },
        { urls: 'stun:global.stun.twilio.com:3478' }
    ];

    if (!peerOptions.config) {
        peerOptions.config = {};
    }
    peerOptions.config.iceServers = ICE_SERVERS;

    const peer = new Peer(customId, peerOptions);
    
    let activeConn = null;
    let zip = null;
    let filesQueue = [];
    let historyData = []; 
    let transferStartTime = 0;

    peer.on('open', id => {
        const tag = document.getElementById('status-tag');
        tag.classList.add('status-online');
        tag.classList.remove('status-error');
        document.getElementById('status-text').innerText = "System Online";
        
        new QRCode(document.getElementById("qrcode"), { 
            text: window.location.href.split('?')[0] + "?join=" + id, 
            width: 140, 
            height: 140,
            colorDark : "#000000",
            colorLight : "#ffffff"
        });
        
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('join')) document.getElementById('peer-id-input').value = urlParams.get('join');
    });

    peer.on('error', err => {
        console.error(err);
        const tag = document.getElementById('status-tag');
        tag.classList.remove('status-online');
        tag.classList.add('status-error');
        document.getElementById('status-text').innerText = "Connection Error";
        if (err.type === 'network' || err.type === 'server-error' || err.type === 'socket-error' || err.type === 'unavailable-id') {
             // Only alert if serious
             console.warn("PeerJS Critical Error:", err.type);
        }
    });

    peer.on('connection', conn => {
        const modal = document.getElementById('connection-modal');
        document.getElementById('conn-req-text').innerText = `Remote device (${conn.peer.substring(0,8)}...) wants to connect. Do you accept?`;
        modal.style.display = 'flex';
        
        const btnAccept = document.getElementById('btn-accept-conn');
        const btnReject = document.getElementById('btn-reject-conn');
        
        const newAccept = btnAccept.cloneNode(true);
        const newReject = btnReject.cloneNode(true);
        btnAccept.parentNode.replaceChild(newAccept, btnAccept);
        btnReject.parentNode.replaceChild(newReject, btnReject);

        newAccept.onclick = () => { 
            modal.style.display = 'none'; 
            setupConnection(conn); 
            // Aggressively try to send ACK
            if(conn.open) conn.send({ type: 'handshake-ack' }); 
            // Also try sending slightly later to ensure connectivity
            setTimeout(() => { if(conn.open) conn.send({ type: 'handshake-ack' }); }, 1000);
        };
        newReject.onclick = () => { modal.style.display = 'none'; conn.close(); };
    });

    document.getElementById('connect-btn').onclick = () => {
        if (activeConn) { activeConn.close(); } 
        else {
            const tid = document.getElementById('peer-id-input').value.trim();
            if (tid) {
                if (peer.disconnected) {
                    alert("Cannot connect: Peer system is disconnected. Check network or server settings.");
                    return;
                }
                const btn = document.getElementById('connect-btn');
                btn.innerHTML = `<i data-lucide="loader-2" class="icon-sm animate-spin"></i> Connecting...`;
                lucide.createIcons();
                
                const conn = peer.connect(tid, { reliable: true });
                setupConnection(conn);
                
                // Monitor ICE State for debugging
                conn.peerConnection.oniceconnectionstatechange = () => {
                    const state = conn.peerConnection.iceConnectionState;
                    console.log("ICE State:", state);
                    if (state === 'failed' || state === 'disconnected') {
                        document.getElementById('transfer-info').innerText = `Connection Failed (${state}). NAT/Firewall block likely.`;
                        updateConnectionUI(false);
                    }
                };

                setTimeout(() => {
                    if (!activeConn || !activeConn.open) {
                        // Don't auto-disconnect here, let ICE try, but warn user
                        document.getElementById('transfer-info').innerText = "Connecting is taking longer than usual... (NAT Traversal)";
                    }
                }, 8000);
            }
        }
    };

    function setupConnection(conn) {
        if (activeConn) return; 
        activeConn = conn;
        
        if (conn.open) {
            updateConnectionUI(true);
            conn.send({ type: 'handshake-ack' }); 
        }

        conn.on('open', () => {
            updateConnectionUI(true);
            conn.send({ type: 'handshake-ack' }); 
            // Keep-alive pinger
            setInterval(() => { if(conn.open) conn.send({type:'ping'}); }, 5000);
        });
        
        conn.on('data', data => { 
            if (data.type === 'handshake-ack') {
                updateConnectionUI(true); 
            } else if (data.type === 'ping') {
                // Heartbeat received, do nothing
            } else {
                handleData(data);
            }
        });
        
        conn.on('close', () => { updateConnectionUI(false); activeConn = null; });
        conn.on('error', () => { updateConnectionUI(false); activeConn = null; alert("Connection lost"); });
    }

    function updateConnectionUI(isConnected) {
        const btn = document.getElementById('connect-btn');
        const input = document.getElementById('peer-id-input');
        const statusText = document.getElementById('status-text');
        const statusTag = document.getElementById('status-tag');
        const fileInput = document.getElementById('file-input');
        
        if (isConnected) {
            statusText.innerText = "Connected";
            statusTag.classList.add('status-online');
            statusTag.classList.remove('status-error');
            fileInput.disabled = false;
            btn.innerHTML = `<i data-lucide="x-circle" class="icon-sm" style="margin-right:5px"></i> Disconnect Device`;
            btn.classList.add('btn-disconnect');
            input.disabled = true;
            document.getElementById('transfer-info').innerText = "Connection Secure. Ready to Transfer.";
        } else {
            if(peer.disconnected) {
                 statusText.innerText = "Offline";
                 statusTag.classList.remove('status-online');
                 statusTag.classList.add('status-error');
            } else {
                 statusText.innerText = "System Online";
                 statusTag.classList.remove('status-online');
                 statusTag.classList.remove('status-error');
            }
            
            fileInput.disabled = true;
            btn.innerHTML = "Connect Device";
            btn.classList.remove('btn-disconnect');
            btn.style.background = ""; 
            input.disabled = false;
            document.getElementById('transfer-info').innerText = "Waiting for connection...";
        }
        lucide.createIcons();
    }

    let receivedChunks = {};
    let expectedHashes = {};
    
    async function handleData(data) {
        if (data.type === 'file-start') {
            if (document.getElementById('zip-mode').checked && !zip) zip = new JSZip();
            receivedChunks[data.name] = [];
            expectedHashes[data.name] = data.hash;
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('metrics-display').style.display = 'flex';
            transferStartTime = Date.now();
        } 
        else if (data.type === 'file-chunk') {
            receivedChunks[data.name].push(data.chunk);
            updateMetrics(data.current * CHUNK_SIZE, data.total * CHUNK_SIZE);
            updateProgress((data.current / data.total) * 100, `Receiving: ${data.name}`);
        } 
        else if (data.type === 'file-end') {
            const blob = new Blob(receivedChunks[data.name]);
            const arrayBuffer = await blob.arrayBuffer();
            const calculatedHash = await calculateHash(arrayBuffer);
            const isVerified = (calculatedHash === expectedHashes[data.name]);
            
            historyData.push({ name: data.name, blob: blob, size: blob.size, verified: isVerified });
            addToHistory('received', data.name, blob.size, isVerified, historyData.length - 1);

            if (data.name.match(/\.(jpg|jpeg|png|webp|gif)$/i)) {
                addFileToBatcher(new File([blob], data.name, { type: blob.type }));
                document.getElementById('smart-toast').style.display = 'flex';
                document.getElementById('batcher-dot').style.display = 'block';
            }

            if (document.getElementById('zip-mode').checked) zip.file(data.name, blob);
            else saveFile(blob, data.name);
            
            delete receivedChunks[data.name];
        } 
        else if (data.type === 'batch-end') {
            if (zip) {
                const content = await zip.generateAsync({type:"blob"});
                saveFile(content, "Transfer_Pack_" + Date.now() + ".zip");
                zip = null;
            }
            document.getElementById('transfer-info').innerText = "Transfer Completed.";
            setTimeout(() => { 
                document.getElementById('progress-container').style.display = 'none';
                document.getElementById('metrics-display').style.display = 'none';
            }, 4000);
        }
    }

    async function sendFiles(files) {
        if (!activeConn) return;
        document.getElementById('progress-container').style.display = 'block';
        document.getElementById('metrics-display').style.display = 'flex';
        
        for (let file of files) {
            const fileBuffer = await file.arrayBuffer();
            const fileHash = await calculateHash(fileBuffer);
            activeConn.send({ type: 'file-start', name: file.name, size: file.size, hash: fileHash });
            
            transferStartTime = Date.now();
            const totalChunks = Math.ceil(fileBuffer.byteLength / CHUNK_SIZE);

            for (let i = 0; i < totalChunks; i++) {
                const chunk = fileBuffer.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
                activeConn.send({ type: 'file-chunk', name: file.name, chunk: chunk, current: i + 1, total: totalChunks });
                updateMetrics((i + 1) * CHUNK_SIZE, file.size);
                updateProgress(((i + 1) / totalChunks) * 100, `Sending: ${file.name}`);
                if (i % 10 === 0) await new Promise(r => setTimeout(r, 1)); 
            }
            activeConn.send({ type: 'file-end', name: file.name });
            addToHistory('sent', file.name, file.size, true);
        }
        activeConn.send({ type: 'batch-end' });
        filesQueue = [];
    }

    function updateMetrics(bytesDone, totalBytes) {
        const now = Date.now();
        const duration = (now - transferStartTime) / 1000;
        if (duration <= 0) return;

        const speedBps = bytesDone / duration;
        document.getElementById('speed-text').innerText = formatBytes(speedBps) + "/s";
        
        const remainingBytes = Math.max(0, totalBytes - bytesDone);
        const etaSeconds = speedBps > 0 ? Math.ceil(remainingBytes / speedBps) : 0;
        document.getElementById('eta-text').innerText = etaSeconds > 60 ? `${Math.floor(etaSeconds/60)}m ${etaSeconds%60}s left` : `${etaSeconds}s left`;
    }

    function addToHistory(type, fileName, fileSize, verified, dataIndex = -1) {
        const list = document.getElementById('history-list');
        if (list.innerHTML.includes('No recent transfers')) list.innerHTML = '';

        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const item = document.createElement('div');
        item.className = 'history-item';
        
        const actionHtml = dataIndex >= 0 ? 
            `<div class="action-icon" title="Save file" onclick="reDownload(${dataIndex})"><i data-lucide="download-cloud" style="width:18px;"></i></div>` : '';

        item.innerHTML = `
            <div class="history-item-left">
                <div style="display:flex; flex-direction:column; overflow:hidden;">
                    <span class="history-name" title="${fileName}">${fileName}</span>
                    <span style="font-size:10px; opacity:0.6;">${formatBytes(fileSize)} • ${time} • ${verified?'Verified ✅':'Error ❌'}</span>
                </div>
            </div>
            <div class="history-actions">${actionHtml}</div>
        `;
        list.prepend(item);
        lucide.createIcons();
    }

    function reDownload(idx) {
        const item = historyData[idx];
        if (item && item.blob) saveFile(item.blob, item.name);
    }

    function clearHistory() { 
        document.getElementById('history-list').innerHTML = '<div style="text-align: center; color: var(--text-dim); padding: 40px 20px; font-size: 12px; font-style: italic;">No recent transfers</div>';
        historyData = [];
    }

    async function calculateHash(buffer) {
        const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function updateProgress(pct, msg) {
        document.getElementById('progress-bar').style.width = pct + "%";
        document.getElementById('transfer-info').innerText = msg;
    }

    function saveFile(blob, name) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = name; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 2000);
    }

    // --- Clock Logic ---
    function updateSystemTime() {
        const now = new Date();
        document.getElementById('system-time').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false});
    }
    setInterval(updateSystemTime, 1000);
    updateSystemTime();

    // --- Queue Management ---
    document.getElementById('file-input').onchange = (e) => {
        if (e.target.files.length > 0) {
            filesQueue = [...filesQueue, ...Array.from(e.target.files)];
            renderPreview();
        }
    };
    function handleAddMoreFiles(input) {
        if(input.files.length > 0) {
            filesQueue = [...filesQueue, ...Array.from(input.files)];
            renderPreview();
            input.value = "";
        }
    }
    function renderPreview() {
        const list = document.getElementById('preview-list');
        const queueCount = document.getElementById('queue-count');
        queueCount.innerText = `${filesQueue.length} files`;
        list.innerHTML = '';
        filesQueue.forEach((f, i) => {
            const item = document.createElement('div');
            item.className = 'preview-item';
            item.innerHTML = `<div class="preview-content"><b title="${f.name}">${f.name}</b><br><small>${formatBytes(f.size)}</small></div><i data-lucide="trash-2" class="preview-remove-btn" onclick="filesQueue.splice(${i},1);renderPreview()"></i>`;
            list.appendChild(item);
        });
        document.getElementById('upload-wrapper').style.display = 'none';
        document.querySelector('.text-btn').style.display = 'none';
        document.getElementById('preview-area').style.display = 'block';
        lucide.createIcons();
    }
    function cancelTransfer() { 
        filesQueue = []; 
        document.getElementById('preview-area').style.display = 'none'; 
        document.getElementById('upload-wrapper').style.display = 'block'; 
        document.querySelector('.text-btn').style.display = 'flex';
    }
    function confirmSend() { if(filesQueue.length) { sendFiles(filesQueue); cancelTransfer(); } }

    // --- Image Batcher ---
    let batcherFiles = [];
    function toggleBatcher(s) { 
        document.getElementById('batcher-modal').style.display = s?'flex':'none'; 
        if(s) {
            document.getElementById('batcher-dot').style.display = 'none';
            renderBatcherGrid(); 
        }
    }
    document.getElementById('batcher-toggle').onclick = () => toggleBatcher(true);
    
    function addFileToBatcher(file) { 
        const id = Math.random();
        batcherFiles.push({ file, id, preview: URL.createObjectURL(file) }); 
    }
    
    function handleBatcherFiles(fl) { 
        Array.from(fl).filter(f=>f.type.startsWith('image/')).forEach(addFileToBatcher); 
        renderBatcherGrid(); 
    }
    
    function renderBatcherGrid() {
        const g = document.getElementById('batcher-grid');
        document.getElementById('batcher-empty').style.display = batcherFiles.length?'none':'flex';
        g.innerHTML = '';
        batcherFiles.forEach(item => {
            const c = document.createElement('div');
            c.className = 'batcher-card';
            c.onclick = (e) => e.stopPropagation();
            c.innerHTML = `<img src="${item.preview}" class="batcher-img"><div class="batcher-remove" onclick="batcherFiles=batcherFiles.filter(f=>f.id!=${item.id});renderBatcherGrid();event.stopPropagation()">×</div>`;
            g.appendChild(c);
        });
    }

    function updateBatcherSettingsUI() {
        const mode = document.getElementById('batcher-resize-mode').value;
        document.getElementById('batcher-scale').style.display = mode==='scale'?'block':'none';
        document.getElementById('batcher-width').style.display = mode==='width'?'block':'none';
    }

    async function runBatcher() {
        if(!batcherFiles.length) return;
        const btn = document.getElementById('batcher-run-btn');
        const log = document.getElementById('batcher-log');
        btn.disabled = true;
        btn.innerText = "Processing...";
        
        const zip = new JSZip();
        const settings = {
            mode: document.getElementById('batcher-resize-mode').value,
            scale: document.getElementById('batcher-scale').value / 100,
            width: parseInt(document.getElementById('batcher-width').value),
            quality: document.getElementById('batcher-quality').value / 100,
            format: document.getElementById('batcher-format').value
        };

        try {
            for (let item of batcherFiles) {
                log.innerText = `Processing ${item.file.name.substring(0,10)}...`;
                const blob = await processImg(item.file, settings);
                const ext = settings.format.split('/')[1];
                zip.file(item.file.name.split('.')[0] + "_processed." + ext, blob);
            }
            const content = await zip.generateAsync({type:"blob"});
            saveFile(content, "Batch_Export_" + Date.now() + ".zip");
            log.innerText = "Processing Complete!";
        } catch(e) { log.innerText = "Error encountered."; }
        
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="zap" class="icon-sm"></i> Run Processor';
        lucide.createIcons();
    }

    function processImg(file, s) {
        return new Promise(res => {
            const img = new Image();
            img.src = URL.createObjectURL(file);
            img.onload = () => {
                const can = document.createElement('canvas');
                let w = img.width, h = img.height;
                if(s.mode === 'scale') { w *= s.scale; h *= s.scale; }
                else { const r = h/w; w = s.width; h = w*r; }
                can.width = w; can.height = h;
                can.getContext('2d').drawImage(img, 0,0, w, h);
                can.toBlob(res, s.format, s.quality);
            }
        });
    }

    // URL Import Logic
    function openUrlModal() { document.getElementById('url-modal').style.display = 'flex'; }
    function closeUrlModal() { document.getElementById('url-modal').style.display = 'none'; document.getElementById('url-input').value=''; }
    
    async function processUrlImport() {
        let url = document.getElementById('url-input').value.trim();
        const info = document.getElementById('transfer-info');
        if (!url) return;
        
        const gdriveRegex = /\/d\/([a-zA-Z0-9_-]+)|id=([a-zA-Z0-9_-]+)/;
        const match = url.match(gdriveRegex);
        
        let isGDrive = false;
        if (match) {
            isGDrive = true;
            const fileId = match[1] || match[2];
            url = `https://drive.google.com/uc?export=download&id=${fileId}`;
        }

        closeUrlModal();
        info.innerText = "Fetching Cloud File...";
        try {
            const useProxy = document.getElementById('cors-proxy-check').checked;
            let res;
            
            if (useProxy || isGDrive) {
                try {
                    res = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
                    if (!res.ok) throw new Error();
                } catch (e) {
                    res = await fetch('https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(url));
                }
            } else {
                res = await fetch(url);
            }

            const blob = await res.blob();
            
            if (isGDrive && blob.type.includes('text/html') && blob.size < 100000) {
                 throw new Error("Virus Scan Warning: File too large for direct fetch.");
            }

            const f = new File([blob], "cloud_import_" + Date.now(), {type: blob.type});
            filesQueue = [f];
            renderPreview();
            info.innerText = "Cloud File Ready.";
        } catch(e) { 
            alert(e.message || "Fetch failed. Try proxy or check file sharing settings."); 
            info.innerText = "Fetch failed."; 
        }
    }

    // Theme Toggle
    document.getElementById('theme-btn').onclick = () => {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        document.getElementById('icon-sun').style.display = next==='light'?'block':'none';
        document.getElementById('icon-moon').style.display = next==='dark'?'block':'none';
    };

    // Copy ID
    document.getElementById('copy-id-btn').onclick = () => {
        navigator.clipboard.writeText(document.getElementById('my-id').innerText);
        const btn = document.getElementById('copy-id-btn');
        btn.innerHTML = '<i data-lucide="check" class="icon" style="color:var(--success)"></i>';
        lucide.createIcons();
        setTimeout(() => { btn.innerHTML = '<i data-lucide="copy" class="icon"></i>'; lucide.createIcons(); }, 2000);
    };
</script>
</body>
</html>
