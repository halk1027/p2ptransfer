<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Air Channel</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --glass-bg: rgba(30, 41, 59, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --input-bg: rgba(15, 23, 42, 0.6);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
            --history-item-bg: rgba(255, 255, 255, 0.05);
            --modal-bg: rgba(15, 23, 42, 0.95);
            --card-bg: rgba(255, 255, 255, 0.03);
        }

        [data-theme="light"] {
            --bg-gradient: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.6);
            --text-main: #1e293b;
            --text-dim: #64748b;
            --primary: #0ea5e9;
            --primary-hover: #0284c7;
            --success: #059669;
            --danger: #ef4444;
            --warning: #d97706;
            --input-bg: rgba(241, 245, 249, 0.7);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --history-item-bg: rgba(0, 0, 0, 0.03);
            --modal-bg: rgba(255, 255, 255, 0.95);
            --card-bg: rgba(255, 255, 255, 0.4);
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            background: var(--bg-gradient); background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            display: flex; flex-direction: column; align-items: center; padding: 20px; color: var(--text-main);
            min-height: 100vh; margin: 0; overflow-x: hidden;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .main-layout { display: flex; flex-direction: row; gap: 24px; width: 100%; max-width: 1400px; align-items: stretch; flex: 1; margin-top: 20px; min-height: 0; /* Fix flex overflow */ }
        @media (max-width: 1024px) {
            .main-layout { flex-direction: column; align-items: center; height: auto; }
            .glass-panel { max-width: 500px !important; width: 100% !important; min-height: auto !important; }
        }

        .glass-panel {
            background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border);
            border-radius: 24px; box-shadow: var(--shadow); padding: 28px; flex: 1; min-width: 300px;
            position: relative; display: flex; flex-direction: column; gap: 15px; /* Increased gap */
            overflow-y: auto; /* Allow scrolling if content is too tall */
        }
        .panel-center { flex: 1.3; }

        .header { width: 100%; max-width: 1400px; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; flex-shrink: 0; }
        .header-left, .header-right { display: flex; align-items: center; gap: 15px; }

        .app-title { font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        #system-time { font-size: 0.9rem; font-family: monospace; color: var(--text-dim); background: rgba(0,0,0,0.1); padding: 6px 12px; border-radius: 12px; border: 1px solid var(--glass-border); }

        .icon-btn { background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-main); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .notification-dot { position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: var(--primary); border-radius: 50%; border: 2px solid var(--input-bg); display: none; }

        .footer { width: 100%; max-width: 1400px; margin-top: 40px; padding: 20px 10px; font-size: 0.75rem; color: var(--text-dim); opacity: 0.7; text-align: left; line-height: 1.5; border-top: 1px solid var(--glass-border); flex-shrink: 0; }

        .icon { width: 20px; height: 20px; } .icon-lg { width: 24px; height: 24px; } .icon-sm { width: 16px; height: 16px; }

        h2 { margin: 0; font-weight: 700; letter-spacing: 1px; word-break: break-all; font-size: 1.1rem; line-height: 1.4; font-family: monospace; color: var(--primary); }
        h3 { margin: 0; color: var(--text-dim); font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; line-height: 1.2; }

        .id-wrapper { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 5px 0; width: 100%; flex-shrink: 0; }
        .copy-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); color: var(--text-dim); width: 36px; height: 36px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .copy-btn:hover { background: var(--primary); color: white; }
        
        #qrcode { margin: 15px auto; padding: 12px; background: white; border-radius: 16px; display: inline-block; flex-shrink: 0; }

        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 14px; margin: 5px 0; border-radius: 12px; border: 1px solid var(--glass-border); background: var(--input-bg); color: var(--text-main); font-size: 14px; outline: none; font-family: inherit; }
        
        button.action-btn { width: 100%; padding: 16px; margin-top: 5px; border-radius: 16px; background: var(--primary); color: white; border: none; cursor: pointer; font-weight: 600; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; flex-shrink: 0; }
        button.action-btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        button.action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-disconnect { background: var(--danger) !important; }

        /* FIXED: Prevent overlap by disallowing shrink and setting min height */
        .file-upload-wrapper { 
            position: relative; margin-top: 10px; border-radius: 16px; overflow: hidden; width: 100%; 
            flex-shrink: 0; min-height: 120px;
        }
        .file-upload-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
        .file-upload-btn { 
            background: var(--input-bg); border: 1px dashed var(--text-dim); color: var(--text-dim); padding: 30px 20px; 
            border-radius: 16px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px; height: 100%; justify-content: center;
        }
        .file-upload-wrapper:hover .file-upload-btn { border-color: var(--primary); background: rgba(255,255,255,0.05); }

        /* FIXED: Text btn spacing */
        .text-btn { 
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--primary); cursor: pointer; 
            font-size: 13px; padding: 12px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; 
            width: 100%; border-radius: 12px; margin-top: 10px; flex-shrink: 0;
        }
        .text-btn:hover { background: rgba(59, 130, 246, 0.1); color: var(--text-main); }

        #status-tag {
            display: inline-flex; align-items: center; gap: 8px; padding: 8px 18px; border-radius: 25px;
            font-size: 13px; font-weight: 700; margin: 5px auto 0 auto;
            background: rgba(59, 130, 246, 0.15); color: var(--primary); border: 1px solid rgba(59, 130, 246, 0.2); flex-shrink: 0;
        }
        #status-tag.status-online { background: rgba(16, 185, 129, 0.2); color: var(--success); border-color: rgba(16, 185, 129, 0.3); }
        #status-tag.status-error { background: rgba(239, 68, 68, 0.15); color: var(--danger); border-color: rgba(239, 68, 68, 0.3); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }

        .progress-container { width: 100%; background: rgba(0,0,0,0.2); height: 8px; border-radius: 4px; margin: 10px 0 5px 0; overflow: hidden; display: none; flex-shrink: 0; }
        #progress-bar { width: 0%; height: 100%; background: var(--primary); border-radius: 4px; transition: width 0.1s linear; }

        .metrics-grid { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-dim); margin: 5px 0 10px 0; font-family: monospace; flex-shrink: 0; }
        .history-list { margin-top: 10px; overflow-y: auto; text-align: left; flex-grow: 1; min-height: 200px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; background: var(--history-item-bg); border-radius: 12px; font-size: 13px; animation: fadeIn 0.3s ease-out; }

        .preview-area { margin-top: 15px; background: rgba(0,0,0,0.2); border-radius: 16px; padding: 15px; border: 1px solid var(--glass-border); display: none; flex-shrink: 0; }
        .preview-list { max-height: 160px; overflow-y: auto; margin-bottom: 15px; }
        .preview-item { display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 8px; font-size: 12px; border-left: 3px solid var(--primary); gap: 10px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(15px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: var(--modal-bg); border: 1px solid var(--glass-border); padding: 24px; border-radius: 24px; width: 90%; max-width: 420px; max-height: 90vh; overflow-y: auto; }
        
        .batcher-layout { display: flex; height: 100%; overflow: hidden; }
        .batcher-sidebar { width: 280px; background: rgba(0,0,0,0.2); border-right: 1px solid var(--glass-border); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; }
        .batcher-main { flex: 1; padding: 25px; overflow-y: auto; background: var(--input-bg); }
        .batcher-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .batcher-card { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 10px; position: relative; }
        .batcher-img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 10px; }
        
        @media (max-width: 768px) {
            .batcher-layout { flex-direction: column; }
            .batcher-sidebar { width: 100%; height: auto; max-height: 45%; border-right: none; border-bottom: 1px solid var(--glass-border); }
        }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 14px 28px; border-radius: 50px; box-shadow: 0 15px 35px rgba(0,0,0,0.4); display: none; align-items: center; gap: 12px; z-index: 3000; font-weight: 600; cursor: pointer; animation: slideUp 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translate(-50%, 150%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        
        .switch-label { display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--text-dim); cursor: pointer; margin: 5px 0; flex-shrink: 0; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-left"><div class="app-title"><i data-lucide="zap" class="icon-lg" style="color: var(--primary);"></i> P2P Air Channel</div></div>
        <div class="header-right">
            <span id="system-time">--:--</span>
            <button class="icon-btn" id="batcher-toggle" title="Image Batcher"><i data-lucide="images" class="icon"></i><div class="notification-dot" id="batcher-dot"></div></button>
            <button class="icon-btn" id="settings-btn" title="Settings" onclick="openSettingsModal()"><i data-lucide="settings" class="icon"></i></button>
            <button class="icon-btn" id="theme-btn" title="Toggle Mode"><i data-lucide="sun" class="icon" id="icon-sun" style="display:none"></i><i data-lucide="moon" class="icon" id="icon-moon"></i></button>
        </div>
    </div>

    <div class="main-layout">
        <!-- IDENTITY -->
        <div class="glass-panel" style="text-align: center;">
            <h3>My Identity</h3>
            <div class="id-wrapper">
                <h2 id="my-id">...</h2>
                <button id="copy-id-btn" class="copy-btn" title="Copy ID"><i data-lucide="copy" class="icon"></i></button>
            </div>
            <div id="qrcode"></div>
            <div id="status-tag"><div class="status-dot"></div><span id="status-text">Initializing...</span></div>
            <p style="font-size:11px; opacity:0.6; margin-top:10px;">Share UUID to establish link.</p>
        </div>

        <!-- CONTROL -->
        <div class="glass-panel panel-center">
            <div style="display:flex; align-items:center; gap:8px;"><i data-lucide="link" class="icon-sm"></i><h3>Connection</h3></div>
            <input type="text" id="peer-id-input" placeholder="Enter remote UUID">
            <button id="connect-btn" class="action-btn">Connect Device</button>
            
            <div style="margin-top:20px; display:flex; align-items:center; gap:8px;"><i data-lucide="file-up" class="icon-sm"></i><h3>File Transfer</h3></div>
            <label class="switch-label"><input type="checkbox" id="zip-mode" style="accent-color:var(--primary); transform:scale(1.1);"> Auto-pack into ZIP</label>

            <div class="file-upload-wrapper" id="upload-wrapper">
                <div class="file-upload-btn" id="drop-zone"><i data-lucide="upload-cloud" class="icon-lg" style="color:var(--primary);"></i><span style="font-weight:500;">Tap or Drop files here</span></div>
                <input type="file" id="file-input" multiple disabled>
            </div>
            <button class="text-btn" onclick="openUrlModal()"><i data-lucide="cloud-download" class="icon-sm"></i><span>Import from Drive / URL</span></button>

            <div id="preview-area" class="preview-area">
                <div style="display:flex; justify-content:space-between; margin-bottom:12px;"><b>Queue</b><span id="queue-count" style="font-size:11px;">0 files</span></div>
                <div id="preview-list" class="preview-list"></div>
                <div style="display:flex; gap:10px;">
                    <button class="action-btn" style="background:transparent; border:1px solid var(--glass-border); flex:1;" onclick="cancelTransfer()">Clear</button>
                    <button class="action-btn" style="background:var(--success); flex:2;" onclick="confirmSend()">Send Now</button>
                </div>
            </div>
            
            <div class="progress-container" id="progress-container"><div id="progress-bar"></div></div>
            <div class="metrics-grid" id="metrics-display" style="display:none">
                <div style="display:flex; align-items:center; gap:4px;"><i data-lucide="gauge" class="icon-sm"></i><span id="speed-text">0 KB/s</span></div>
                <div style="display:flex; align-items:center; gap:4px;"><i data-lucide="timer" class="icon-sm"></i><span id="eta-text">--s left</span></div>
            </div>
            <div id="transfer-info" style="font-size: 12px; color: var(--text-dim); text-align: center;">Waiting...</div>
        </div>

        <!-- HISTORY -->
        <div class="glass-panel">
            <div style="display:flex; align-items:center; justify-content:space-between;"><div style="display:flex; align-items:center; gap:8px;"><i data-lucide="history" class="icon-sm"></i><h3>Activity</h3></div><span style="font-size:11px; cursor:pointer; opacity:0.6;" onclick="clearHistory()">Clear</span></div>
            <div id="history-list" class="history-list">
                <div style="text-align: center; color: var(--text-dim); padding: 40px 20px; font-size: 12px; font-style: italic;">No history</div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Network Settings</h3>
            <label style="font-size:11px;">Server Preset</label>
            <select id="conf-preset" onchange="applyPreset()">
                <option value="render">Default (Render Proxy)</option>
                <option value="public">Public (0.peerjs.com)</option>
                <option value="custom">Custom Server</option>
            </select>
            <div style="background:rgba(59,130,246,0.1); padding:12px; border-radius:12px; border:1px solid rgba(59,130,246,0.2); margin-top:10px;">
                <label style="font-size:11px; font-weight:700;">Metered.ca API Key</label>
                <input type="text" id="metered-key" placeholder="Paste Metered Key here">
                <p style="font-size:10px; color:var(--text-dim);">Enable 100% traversal via Port 443 Relay.</p>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="action-btn" style="background:transparent; border:1px solid var(--glass-border); flex:1;" onclick="closeSettingsModal()">Cancel</button>
                <button class="action-btn" style="flex:2;" onclick="savePeerConfig()">Save & Reload</button>
            </div>
        </div>
    </div>

    <div id="url-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Cloud Import</h3>
            <input type="text" id="url-input" placeholder="GDrive Link or Direct URL">
            <label class="switch-label" style="font-size:13px;"><input type="checkbox" id="cors-proxy-check" checked> Use Proxy</label>
            <div class="warning-text">⚠️ Warning: Using a proxy sends traffic through a third-party server. Do not use for sensitive data.</div>
            <div style="display:flex; gap:10px; margin-top:20px;"><button class="action-btn" style="background:transparent; border:1px solid var(--glass-border); flex:1;" onclick="closeUrlModal()">Cancel</button><button class="action-btn" style="flex:2;" onclick="processUrlImport()">Fetch</button></div>
        </div>
    </div>

    <div id="batcher-modal" class="modal-overlay">
        <div class="modal-content" style="width: 95%; max-width: 900px; height: 85vh; padding: 0; display: flex; flex-direction: column;">
            <div style="padding:18px 24px; border-bottom:1px solid var(--glass-border); display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:10px;"><i data-lucide="layers" style="color:var(--primary);"></i><h3 style="margin:0;">Image Batcher Pro</h3></div>
                <i data-lucide="x" style="cursor:pointer;" onclick="toggleBatcher(false)"></i>
            </div>
            <div class="batcher-layout">
                <div class="batcher-sidebar">
                    <select id="batcher-resize-mode"><option value="scale">Scale %</option><option value="width">Fixed Width</option></select>
                    <input type="range" class="range-slider" id="batcher-quality" min="10" max="100" value="80">
                    <select id="batcher-format"><option value="image/jpeg">JPG (Photos)</option><option value="image/png">PNG (Lossless)</option><option value="image/webp">WebP (Efficient)</option></select>
                    <button class="action-btn" style="margin-top:auto;" onclick="runBatcher()" id="batcher-run-btn"><i data-lucide="zap"></i> Process & Zip</button>
                    <div id="batcher-log" style="font-size:11px; text-align:center;"></div>
                </div>
                <div class="batcher-main" id="batcher-dropzone" onclick="document.getElementById('batcher-input').click()">
                    <input type="file" id="batcher-input" multiple accept="image/*" style="display:none" onchange="handleBatcherFiles(this.files)">
                    <div id="batcher-empty" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; opacity:0.4;"><i data-lucide="image-plus" style="width:48px;height:48px;"></i><p>Add Images</p></div>
                    <div class="batcher-grid" id="batcher-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="smart-toast" class="toast" onclick="toggleBatcher(true); this.style.display='none';"><i data-lucide="sparkles"></i><span>Images Detected! Open Batcher?</span></div>

<script>
    lucide.createIcons();
    const CHUNK_SIZE = 65536; 
    
    function generateUUID() {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => (Math.random()*16|0).toString(16));
    }

    const PRESETS = {
        render: { host: 'my-p2p-server.onrender.com', port: 443, path: '/myapp', secure: true },
        public: { host: '0.peerjs.com', port: 443, path: '/', secure: true }
    };

    async function fetchTurn(apiKey) {
        try { const res = await fetch(`https://metered.ca/api/v1/turn/credentials?apiKey=${apiKey}`); return await res.json(); } catch(e) { return null; }
    }

    async function init() {
        const config = JSON.parse(localStorage.getItem('peerConfig')) || PRESETS.render;
        const meteredKey = localStorage.getItem('meteredKey');
        let ice = [ { urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun.nextcloud.com:443' } ];
        
        if (meteredKey) { const mi = await fetchTurn(meteredKey); if (mi) ice = [...ice, ...mi]; }

        const peer = new Peer(generateUUID(), {
            host: config.host, port: config.port, path: config.path, secure: config.secure,
            config: { iceServers: ice, iceTransportPolicy: 'all' }
        });

        window.peer = peer;
        peer.on('open', id => {
            document.getElementById('my-id').innerText = id;
            const tag = document.getElementById('status-tag');
            tag.classList.add('status-online');
            document.getElementById('status-text').innerText = "System Online";
            new QRCode(document.getElementById("qrcode"), { text: window.location.href.split('?')[0] + "?join=" + id, width: 140, height: 140 });
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('join')) document.getElementById('peer-id-input').value = urlParams.get('join');
        });

        peer.on('connection', conn => {
            if(confirm(`Incoming connection from ${conn.peer.substring(0,8)}... Accept?`)) setupConn(conn);
            else conn.close();
        });

        peer.on('error', () => { 
            document.getElementById('status-tag').classList.add('status-error'); 
            document.getElementById('status-text').innerText = "Network Error";
        });
    }

    function setupConn(conn) {
        window.activeConn = conn;
        conn.on('open', () => {
            updateUI(true);
            conn.send({ type: 'handshake-ack' });
            setInterval(() => { if(conn.open) conn.send({type:'ping'}); }, 5000);
        });
        conn.on('data', data => {
            if(data.type === 'handshake-ack') updateUI(true);
            else handleData(data);
        });
        conn.on('close', () => updateUI(false));
    }

    function updateUI(c) {
        const btn = document.getElementById('connect-btn');
        const tag = document.getElementById('status-tag');
        if(c) {
            btn.innerText = "Disconnect Channel";
            btn.classList.add('btn-disconnect');
            tag.classList.add('status-online');
            document.getElementById('status-text').innerText = "Connected";
            document.getElementById('file-input').disabled = false;
        } else {
            btn.innerText = "Connect Device";
            btn.classList.remove('btn-disconnect');
        }
        lucide.createIcons();
    }

    // --- File Handlers ---
    let receivedChunks = {};
    let transferStartTime = 0;
    let historyData = [];

    async function handleData(data) {
        if (data.type === 'file-start') {
            receivedChunks[data.name] = [];
            transferStartTime = Date.now();
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('metrics-display').style.display = 'flex';
        } else if (data.type === 'file-chunk') {
            receivedChunks[data.name].push(data.chunk);
            updateProgress((receivedChunks[data.name].length / data.total) * 100, `Receiving: ${data.name}`);
            updateMetrics(receivedChunks[data.name].length * CHUNK_SIZE, data.total * CHUNK_SIZE);
        } else if (data.type === 'file-end') {
            const blob = new Blob(receivedChunks[data.name]);
            saveFile(blob, data.name);
            historyData.push({ name: data.name, blob });
            addHistory('IN', data.name, blob.size, historyData.length - 1);
            if (data.name.match(/\.(jpg|jpeg|png|webp|gif)$/i)) {
                addFileToBatcher(new File([blob], data.name, { type: blob.type }));
                document.getElementById('smart-toast').style.display = 'flex';
            }
            delete receivedChunks[data.name];
        }
    }

    function updateMetrics(done, total) {
        const now = Date.now(), sec = (now - transferStartTime) / 1000;
        if(sec <= 0) return;
        const speed = done / sec;
        document.getElementById('speed-text').innerText = formatBytes(speed) + "/s";
        const eta = speed > 0 ? Math.ceil((total - done) / speed) : 0;
        document.getElementById('eta-text').innerText = (eta > 60 ? Math.floor(eta/60) + "m" : eta + "s") + " left";
    }

    // --- Helpers ---
    function formatBytes(b) { if(b===0) return '0 B'; const k=1024, s=['B','KB','MB','GB','TB'], i=Math.floor(Math.log(b)/Math.log(k)); return parseFloat((b/Math.pow(k,i)).toFixed(2))+' '+s[i]; }
    function saveFile(b, n) { const u=URL.createObjectURL(b), a=document.createElement('a'); a.href=u; a.download=n; a.click(); }
    function updateProgress(p, m) { document.getElementById('progress-bar').style.width = p+"%"; document.getElementById('transfer-info').innerText = m; }
    
    function addHistory(t, n, s, idx) {
        const list = document.getElementById('history-list'); if(list.innerHTML.includes('No history')) list.innerHTML = '';
        const item = document.createElement('div'); item.className = 'history-item';
        item.innerHTML = `<div style="display:flex; flex-direction:column; overflow:hidden;"><span style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${n}</span><span style="font-size:10px; opacity:0.6;">${formatBytes(s)} • ${t}</span></div>`;
        list.prepend(item);
    }

    // --- Modals & Presets ---
    function openSettingsModal() { document.getElementById('settings-modal').style.display = 'flex'; document.getElementById('metered-key').value = localStorage.getItem('meteredKey') || ''; }
    function closeSettingsModal() { document.getElementById('settings-modal').style.display = 'none'; }
    function savePeerConfig() { const k = document.getElementById('metered-key').value.trim(); localStorage.setItem('meteredKey', k); const p = document.getElementById('conf-preset').value; if(p!=='custom') localStorage.setItem('peerConfig', JSON.stringify(PRESETS[p])); location.reload(); }
    function applyPreset() {}
    function openUrlModal() { document.getElementById('url-modal').style.display = 'flex'; }
    function closeUrlModal() { document.getElementById('url-modal').style.display = 'none'; }
    function clearHistory() { document.getElementById('history-list').innerHTML = ''; historyData = []; }

    // Send files logic
    document.getElementById('file-input').onchange = (e) => { if (e.target.files.length > 0) sendFiles(Array.from(e.target.files)); };
    async function sendFiles(files) {
        if (!activeConn) return;
        document.getElementById('progress-container').style.display = 'block';
        document.getElementById('metrics-display').style.display = 'flex';
        for (let file of files) {
            activeConn.send({ type: 'file-start', name: file.name, size: file.size });
            transferStartTime = Date.now();
            const total = Math.ceil(file.size / CHUNK_SIZE);
            for (let i = 0; i < total; i++) {
                const chunk = file.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
                activeConn.send({ type: 'file-chunk', name: file.name, chunk, current: i + 1, total });
                updateMetrics((i + 1) * CHUNK_SIZE, file.size);
                updateProgress(((i + 1) / total) * 100, `Sending: ${file.name}`);
                if (i % 10 === 0) await new Promise(r => setTimeout(r, 1));
            }
            activeConn.send({ type: 'file-end', name: file.name });
            addHistory('OUT', file.name, file.size, -1);
        }
    }

    // Batcher simplified
    let batcherFiles = [];
    function toggleBatcher(s) { document.getElementById('batcher-modal').style.display = s?'flex':'none'; if(s) renderBatcher(); }
    function addFileToBatcher(f) { batcherFiles.push({ f, id: Math.random(), preview: URL.createObjectURL(f) }); }
    function handleBatcherFiles(fl) { Array.from(fl).filter(f=>f.type.startsWith('image/')).forEach(addFileToBatcher); renderBatcher(); }
    function renderBatcher() {
        const g = document.getElementById('batcher-grid'); document.getElementById('batcher-empty').style.display = batcherFiles.length?'none':'flex';
        g.innerHTML = ''; batcherFiles.forEach(item => {
            const c = document.createElement('div'); c.className = 'batcher-card';
            c.innerHTML = `<img src="${item.preview}" class="batcher-img"><div style="position:absolute; top:-5px; right:-5px; background:red; color:white; border-radius:50%; width:20px; height:20px; text-align:center; cursor:pointer;" onclick="batcherFiles=batcherFiles.filter(i=>i.id!=${item.id});renderBatcher();event.stopPropagation()">×</div>`;
            g.appendChild(c);
        });
    }

    setInterval(() => { document.getElementById('system-time').innerText = new Date().toLocaleTimeString([], {hour12:false}); }, 1000);
    document.getElementById('theme-btn').onclick = () => {
        const cur = document.documentElement.getAttribute('data-theme');
        const next = cur === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        document.getElementById('icon-sun').style.display = next==='light'?'block':'none';
        document.getElementById('icon-moon').style.display = next==='dark'?'block':'none';
    };

    document.getElementById('connect-btn').onclick = () => {
        if(window.activeConn) { location.reload(); return; }
        const tid = document.getElementById('peer-id-input').value.trim();
        if(tid) { document.getElementById('connect-btn').innerText = "Traversing NAT..."; setupConn(window.peer.connect(tid, { reliable: true })); }
    };

    init();
</script>
</body>
</html>
